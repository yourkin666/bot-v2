<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title> AI å°å­</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css" rel="stylesheet">
<script src="https://cdn.tailwindcss.com/3.4.16"></script>
<script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
<script>
tailwind.config = {
theme: {
extend: {
colors: {
primary: '#3B82F6',
secondary: '#6B7280'
},
borderRadius: {
'none': '0px',
'sm': '4px',
DEFAULT: '8px',
'md': '12px',
'lg': '16px',
'xl': '20px',
'2xl': '24px',
'3xl': '32px',
'full': '9999px',
'button': '8px'
}
}
}
}
</script>
<style>
/* ç§»é™¤å¼ºåˆ¶å›¾æ ‡å†…å®¹ï¼Œè®©å›¾æ ‡æ­£å¸¸æ˜¾ç¤º */

/* é¡µé¢åŸºç¡€æ ·å¼ - ç§»é™¤é»˜è®¤è¾¹è·å’Œè®¾ç½®å…¨é«˜åº¦ */
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

html, body {
height: 100%;
min-height: 100vh;
overflow: hidden;
}

.chat-container {
height: calc(100vh - 80px);
}
.chat-messages {
scroll-behavior: smooth;
}
.message-input:focus {
outline: none;
}
.history-item {
transition: all 0.2s ease;
}
.history-item:hover {
background-color: rgb(239 246 255);
color: rgb(37 99 235);
}
.active-chat {
background: rgb(239 246 255);
color: rgb(37 99 235);
}
.active-chat:hover {
background: rgb(219 234 254);
color: rgb(29 78 216);
transform: none;
}
.thinking-process {
max-height: 0;
overflow: hidden;
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.thinking-process.expanded {
max-height: 500px;
}
.chat-messages::-webkit-scrollbar {
width: 6px;
}
.chat-messages::-webkit-scrollbar-track {
background: transparent;
}
.chat-messages::-webkit-scrollbar-thumb {
background-color: #E5E7EB;
border-radius: 20px;
}
.glass-effect {
background: rgba(255, 255, 255, 0.8);
backdrop-filter: blur(16px);
box-shadow:
0 8px 32px rgba(0, 0, 0, 0.03),
0 1px 2px rgba(255, 255, 255, 0.2) inset,
0 -1px 2px rgba(0, 0, 0, 0.03) inset;
border: 1px solid rgba(255, 255, 255, 0.4);
}
.message-input {
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.message-input:focus {
background-color: white;
box-shadow:
0 4px 12px rgba(59, 130, 246, 0.08),
0 2px 4px rgba(59, 130, 246, 0.03);
border: 1px solid rgba(59, 130, 246, 0.1);
}
.button-hover-effect {
transition: all 0.2s ease;
}
.button-hover-effect:hover {
transform: translateY(-2px);
box-shadow:
0 4px 16px rgba(59, 130, 246, 0.25),
0 2px 4px rgba(59, 130, 246, 0.1);
}
.button-hover-effect:active {
transform: translateY(0);
}
.toggle-button.active {
background-color: rgb(59, 130, 246);
color: white;
}
.toggle-button.active:hover {
background-color: rgb(37, 99, 235);
}
.typing-cursor {
animation: blink 1s infinite;
font-weight: bold;
color: #3B82F6;
}
@keyframes blink {
0%, 50% { opacity: 1; }
51%, 100% { opacity: 0; }
}

/* è¾“å…¥æ¡†å“åº”çŠ¶æ€åŠ¨ç”» */
@keyframes pulse-border {
0%, 100% { 
  box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
  border-color: #3B82F6;
}
50% { 
  box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
  border-color: #1D4ED8;
}
}

/* ä¸­æ–­æç¤ºåŠ¨ç”» */
@keyframes bounce-in {
0% {
  opacity: 0;
  transform: translateY(10px) scale(0.8);
}
50% {
  transform: translateY(-5px) scale(1.05);
}
100% {
  opacity: 1;
  transform: translateY(0) scale(1);
}
}

@keyframes fade-out {
0% {
  opacity: 1;
  transform: scale(1);
}
100% {
  opacity: 0;
  transform: scale(0.9);
}
}

/* ä¸­æ–­æŒ‰é’®è„‰å†²æ•ˆæœ */
@keyframes interrupt-pulse {
0%, 100% {
  box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
  transform: scale(1.05);
}
50% {
  box-shadow: 0 0 0 6px rgba(239, 68, 68, 0.2);
  transform: scale(1.08);
}
}

/* åˆ é™¤æŒ‰é’®æ ·å¼ */
.delete-chat-btn {
transition: all 0.2s ease;
}
.delete-chat-btn:hover {
transform: scale(1.1);
}
.delete-chat-btn:disabled {
opacity: 0.5;
cursor: not-allowed;
}

/* æ–°å¯¹è¯æŒ‰é’®ç¦ç”¨çŠ¶æ€ */
.new-chat-btn:disabled {
opacity: 0.6;
cursor: not-allowed;
transform: none !important;
}

/* å†å²è®°å½•é¡¹hoveræ•ˆæœ */
.history-item .group:hover {
background-color: rgba(239, 246, 255, 0.5);
}

/* æ¨¡æ€æ¡†åŠ¨ç”» */
.modal-enter {
animation: modalEnter 0.3s ease-out;
}
@keyframes modalEnter {
from {
opacity: 0;
transform: scale(0.9);
}
to {
opacity: 1;
transform: scale(1);
}
}

/* æç¤ºæ¡†æ ·å¼ */
.toast {
backdrop-filter: blur(8px);
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

/* å†å²è®°å½•é¡¹é€‰ä¸­çŠ¶æ€ */
.history-item.active-chat {
background: linear-gradient(135deg, #EEF3FE 0%, #E0EFFF 100%);
border-left: 3px solid #4E89FD;
}

/* Markdown æ ·å¼ */
.markdown-content h1 {
font-size: 1.875rem;
font-weight: 700;
margin: 1.5rem 0 1rem 0;
line-height: 1.2;
color: #1f2937;
}
.markdown-content h2 {
font-size: 1.5rem;
font-weight: 600;
margin: 1.25rem 0 0.75rem 0;
line-height: 1.3;
color: #374151;
}
.markdown-content h3 {
font-size: 1.25rem;
font-weight: 600;
margin: 1rem 0 0.5rem 0;
line-height: 1.4;
color: #4b5563;
}
.markdown-content p {
margin: 0.75rem 0;
line-height: 1.6;
color: #374151;
}
.markdown-content strong {
font-weight: 600;
color: #1f2937;
}
.markdown-content em {
font-style: italic;
color: #4b5563;
}
.markdown-content code {
background-color: #f3f4f6;
padding: 0.125rem 0.25rem;
border-radius: 0.25rem;
font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
font-size: 0.875rem;
color: #dc2626;
}
.markdown-content pre {
background-color: #1f2937;
color: #f9fafb;
padding: 1rem;
border-radius: 0.5rem;
overflow-x: auto;
margin: 1rem 0;
}
.markdown-content pre code {
background-color: transparent;
padding: 0;
color: inherit;
font-size: 0.875rem;
}
.markdown-content ul, .markdown-content ol {
margin: 0.75rem 0;
padding-left: 1.5rem;
}
.markdown-content li {
margin: 0.25rem 0;
line-height: 1.5;
}
.markdown-content blockquote {
border-left: 4px solid #3b82f6;
background-color: #eff6ff;
padding: 0.75rem 1rem;
margin: 1rem 0;
font-style: italic;
color: #1e40af;
}
.markdown-content a {
color: #3b82f6;
text-decoration: underline;
}
.markdown-content a:hover {
color: #1d4ed8;
}
.markdown-content table {
width: 100%;
border-collapse: collapse;
margin: 1rem 0;
}
.markdown-content th, .markdown-content td {
border: 1px solid #d1d5db;
padding: 0.5rem;
text-align: left;
}
.markdown-content th {
background-color: #f9fafb;
font-weight: 600;
}
.markdown-content hr {
border: none;
border-top: 1px solid #e5e7eb;
margin: 1.5rem 0;
}

/* æ•°å­¦å…¬å¼æ ·å¼ */
.katex {
font-size: 1em;
}
.katex-display {
margin: 1rem 0;
text-align: center;
}
.markdown-content .katex-display {
background-color: #f8fafc;
padding: 1rem;
border-radius: 0.5rem;
border: 1px solid #e2e8f0;
overflow-x: auto;
}
.markdown-content .katex-html {
overflow-x: auto;
overflow-y: hidden;
}

/* æ•°å­¦å…¬å¼å®¹å™¨çš„ç¨³å®šæ€§ï¼Œé˜²æ­¢è·³åŠ¨ */
.katex-display, .katex {
min-height: 1.2em;
transition: none;
}

/* ä¼˜åŒ–æ•°å­¦å…¬å¼æ˜¾ç¤º */
.markdown-content {
transition: none;
}
</style>
</head>
<body class="bg-[conic-gradient(at_top,_var(--tw-gradient-stops))] from-white via-sky-50 to-blue-50/30 font-sans text-gray-900">
<div class="flex h-full w-full">
<!-- å·¦ä¾§è¾¹æ  -->
<div class="w-64 bg-white/90 backdrop-blur-2xl border-r border-white/50 flex flex-col shadow-[0_0_50px_rgba(0,0,0,0.05)]">
<!-- å“ç‰Œæ ‡è¯† -->
<div class="p-4 flex items-center justify-between">
		<div class="flex items-center gap-3">
			<!-- Logoå›¾æ ‡ -->
			<div class="relative">
				<div class="w-10 h-10 bg-gradient-to-br from-blue-500 via-purple-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-200/50 transform rotate-3 hover:rotate-0 transition-transform duration-300">
					<i class="ri-robot-line text-white text-lg"></i>
				</div>
				<div class="absolute -top-1 -right-1 w-3 h-3 bg-gradient-to-r from-green-400 to-blue-500 rounded-full animate-pulse"></div>
			</div>
			<!-- Logoæ–‡å­— -->
			<div class="flex flex-col">
				<div class="font-bold text-xl bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 bg-clip-text text-transparent">
					AIå°å­
				</div>
				<div class="text-xs text-gray-400 font-medium tracking-wide">
					æ™ºèƒ½åŠ©æ‰‹
				</div>
			</div>
		</div>
<div class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-gray-700 transition-colors cursor-pointer">
<i class="ri-menu-line ri-lg"></i>
</div>
</div>
<!-- æ–°å¯¹è¯æŒ‰é’® -->
<div class="p-3">
		<button id="sidebar-new-chat-btn" class="new-chat-btn bg-blue-50 text-blue-600 py-1.5 px-4 flex items-center justify-center gap-1.5 rounded-full hover:bg-blue-100 transition-colors text-sm mx-auto whitespace-nowrap">
			<i class="ri-add-line text-xs"></i>
			<span>å¼€å¯æ–°å¯¹è¯</span>
		</button>
</div>
<!-- å¯¹è¯å†å² -->
<div class="flex-1 overflow-y-auto">
	<div id="history-container">
		<!-- å†å²å¯¹è¯å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
		<div class="p-3 text-center text-gray-400 text-sm">
			<i class="ri-loader-4-line animate-spin mr-1"></i>
			æ­£åœ¨åŠ è½½å†å²å¯¹è¯...
</div>
</div>
</div>
<!-- åº•éƒ¨åŠŸèƒ½åŒº -->
<div class="p-3 border-t border-gray-100 space-y-2">
<!-- åŠŸèƒ½åŒºåŸŸé¢„ç•™ï¼Œå¯ä»¥æ·»åŠ å…¶ä»–å·¥å…· -->
</div>
</div>
<!-- ä¸­é—´èŠå¤©åŒºåŸŸ -->
<div class="flex-1 flex flex-col bg-white">
<!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
<div class="flex-1 overflow-y-auto chat-messages p-4">
<!-- åˆå§‹æ¬¢è¿ä¿¡æ¯ -->
<div id="welcome-message" class="flex flex-col items-center justify-center h-full">
<div class="relative mb-6">
<div class="w-20 h-20 bg-gradient-to-br from-blue-500 via-purple-500 to-indigo-600 rounded-2xl flex items-center justify-center shadow-2xl shadow-blue-200/50 ring-8 ring-white/80 backdrop-blur-xl transform rotate-3 hover:rotate-0 transition-transform duration-500">
<i class="ri-robot-line text-white text-3xl"></i>
</div>
<div class="absolute -top-2 -right-2 w-6 h-6 bg-gradient-to-r from-green-400 to-blue-500 rounded-full animate-pulse flex items-center justify-center">
<div class="w-2 h-2 bg-white rounded-full"></div>
</div>
</div>
			<h2 class="text-xl font-medium mb-2">æˆ‘æ˜¯ <span class="bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 bg-clip-text text-transparent font-bold">AIå°å­</span>ï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼</h2>
			<p class="text-gray-500 text-center max-w-md mb-4">æˆ‘å¯ä»¥å¸®ä½ å†™ä»£ç ã€å›ç­”é—®é¢˜ã€ç”Ÿæˆå†…å®¹ã€‚è¯·æŠŠä½ çš„ä»»åŠ¡äº¤ç»™æˆ‘å§ï½</p>
</div>
<!-- èŠå¤©æ¶ˆæ¯å®¹å™¨ (åŠ¨æ€ç”Ÿæˆå†…å®¹) -->
<div id="chat-content" class="hidden space-y-6">
<!-- çœŸå®çš„èŠå¤©æ¶ˆæ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
</div>
</div>
<!-- æ–°å¯¹è¯æŒ‰é’® (åˆå§‹éšè—) -->
<div id="new-chat-button" class="hidden px-4 py-2">
	<button id="chat-new-chat-btn" class="new-chat-btn bg-[#EEF3FE] text-[#4E89FD] py-1.5 px-4 flex items-center justify-center gap-1.5 rounded-full hover:bg-blue-100 transition-colors text-sm mx-auto whitespace-nowrap">
		<i class="ri-add-line text-xs"></i>
		<span>å¼€å¯æ–°å¯¹è¯</span>
	</button>
</div>
<!-- è¾“å…¥åŒºåŸŸ -->
<div class="p-4">
<div class="flex items-center gap-2 mb-3">

		<button id="search-toggle" class="toggle-button bg-gray-50 text-gray-600 py-1.5 px-3 rounded-lg text-sm flex items-center gap-1 whitespace-nowrap hover:bg-gray-100 transition-colors">
			<div class="w-4 h-4 flex items-center justify-center">
				<i class="ri-search-line"></i>
			</div>
			<span>è”ç½‘æœç´¢</span>
		</button>
</div>
<div class="relative">
<textarea
class="message-input w-full bg-gray-50 rounded-lg pl-4 pr-12 py-3 resize-none border-none h-12 text-gray-800 focus:bg-gray-100 transition-colors"
				placeholder="ç»™ AIå°å­ å‘é€æ¶ˆæ¯"
rows="1"
></textarea>
				<div class="absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-2">
					<button class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-gray-700">
						<i class="ri-attachment-2"></i>
					</button>
					<button id="voice-button" class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-primary transition-colors" title="ç‚¹å‡»å½•éŸ³">
						<i class="ri-mic-line"></i>
					</button>
					<button id="send-button" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-primary">
						<i class="ri-send-plane-fill"></i>
					</button>
				</div>
</div>
</div>
</div>
</div>
<script id="chat-interaction">
// ç®€åŒ–çš„Markdownæ¸²æŸ“å‡½æ•° - ç›´æ¥å¤„ç†ï¼Œè®©KaTeXåç»­æ¸²æŸ“æ•°å­¦å…¬å¼
function renderMarkdown(text) {
if (typeof marked === 'undefined') {
return text.replace(/\n/g, '<br>');
}

try {
// é…ç½®markedé€‰é¡¹
marked.setOptions({
breaks: true,
gfm: true,
sanitize: false
});

// ç›´æ¥æ¸²æŸ“Markdownï¼Œä¸è¿›è¡Œå¤æ‚çš„å ä½ç¬¦å¤„ç†
// è®©KaTeXåœ¨åç»­æ­¥éª¤ä¸­ç›´æ¥å¤„ç†æ•°å­¦å…¬å¼
let rendered = marked.parse(text);

// ä½¿ç”¨DOMPurifyæ¸…ç†HTMLä»¥é˜²æ­¢XSSæ”»å‡»
rendered = typeof DOMPurify !== 'undefined' ? DOMPurify.sanitize(rendered, {
ADD_TAGS: ['math', 'semantics', 'mrow', 'mi', 'mo', 'mn', 'msup', 'msub', 'mfrac', 'msqrt'],
ADD_ATTR: ['class', 'style']
}) : rendered;

// æ¸…ç†ä»»ä½•å¯èƒ½çš„å ä½ç¬¦æ®‹ç•™
rendered = cleanupMathPlaceholders(rendered);

return rendered;
} catch (error) {
console.error('Markdownæ¸²æŸ“é”™è¯¯:', error);
return text.replace(/\n/g, '<br>');
}
}

// æ¸…ç†æ•°å­¦å…¬å¼å ä½ç¬¦çš„è¾…åŠ©å‡½æ•°
function cleanupMathPlaceholders(text) {
// ç§»é™¤æ‰€æœ‰å½¢å¦‚ MATH_BLOCK_N æˆ– MATH_INLINE_N çš„å ä½ç¬¦
text = text.replace(/MATH_(BLOCK|INLINE)_\d+/g, '[æ•°å­¦å…¬å¼]');
// ç§»é™¤æ‰€æœ‰å½¢å¦‚ __MATH_BLOCK_N__ æˆ– __MATH_INLINE_N__ çš„å ä½ç¬¦
text = text.replace(/__MATH_(BLOCK|INLINE)_\d+__/g, '[æ•°å­¦å…¬å¼]');
return text;
}

// è¿™äº›å‡½æ•°å·²ç»ä¸å†éœ€è¦ï¼Œå› ä¸ºæˆ‘ä»¬ç®€åŒ–äº†æ¸²æŸ“é€»è¾‘

// è½¬ä¹‰æ­£åˆ™è¡¨è¾¾å¼ç‰¹æ®Šå­—ç¬¦
function escapeRegExp(string) {
return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// æ•°å­¦å…¬å¼æ¸²æŸ“é…ç½®
const mathConfig = {
delimiters: [
{left: '$$', right: '$$', display: true},
{left: '$', right: '$', display: false},
{left: '\\(', right: '\\)', display: false},
{left: '\\[', right: '\\]', display: true}
],
throwOnError: false,
errorColor: '#cc0000',
strict: false
};

// ç­‰å¾…KaTeXåŠ è½½å®Œæˆçš„å‡½æ•° - ä¼˜åŒ–ç‰ˆæœ¬
function waitForKaTeX() {
return new Promise((resolve, reject) => {
if (typeof window.renderMathInElement === 'function') {
resolve();
return;
}

let attempts = 0;
const maxAttempts = 30; // 3ç§’è¶…æ—¶ï¼Œå‡å°‘ç­‰å¾…æ—¶é—´
const checkKaTeX = setInterval(() => {
attempts++;

if (typeof window.renderMathInElement === 'function') {
clearInterval(checkKaTeX);
resolve();
} else if (attempts >= maxAttempts) {
clearInterval(checkKaTeX);
reject(new Error('KaTeXåŠ è½½è¶…æ—¶'));
}
}, 100);
});
}

// å®‰å…¨æ¸²æŸ“æ•°å­¦å…¬å¼ - é˜²é—ªåŠ¨ç»ˆæç‰ˆæœ¬
async function renderMathSafely(element) {
if (!element) return;

try {
await waitForKaTeX();
if (typeof window.renderMathInElement === 'function') {
// åˆ›å»ºä¸€ä¸ªå…‹éš†å…ƒç´ åœ¨åå°æ¸²æŸ“
const clone = element.cloneNode(true);
clone.style.visibility = 'hidden';
clone.style.position = 'absolute';
clone.style.top = '-9999px';
element.parentElement.appendChild(clone);

// åœ¨å…‹éš†å…ƒç´ ä¸Šæ¸²æŸ“æ•°å­¦å…¬å¼
window.renderMathInElement(clone, mathConfig);

// æ¸²æŸ“å®Œæˆåï¼Œä¸€æ¬¡æ€§æ›¿æ¢å†…å®¹
element.innerHTML = clone.innerHTML;

// æ¸…ç†å…‹éš†å…ƒç´ 
clone.remove();
}
} catch (error) {
console.error('æ•°å­¦å…¬å¼æ¸²æŸ“é”™è¯¯:', error);
}
}

document.addEventListener('DOMContentLoaded', function() {
	const messageInput = document.querySelector('.message-input');
	const sendButton = document.getElementById('send-button');
	const voiceButton = document.getElementById('voice-button');
	const welcomeMessage = document.getElementById('welcome-message');
	const chatContent = document.getElementById('chat-content');
	const newChatButton = document.getElementById('new-chat-button');
	const searchToggle = document.getElementById('search-toggle');

// é¡µé¢åŠ è½½æ—¶é‡ç½®çŠ¶æ€
window.isAIResponding = false;
disableUserInput(false);

// å»¶è¿Ÿæ£€æŸ¥æ•°å­¦å…¬å¼åº“æ˜¯å¦åŠ è½½å®Œæˆ
setTimeout(() => {
if (typeof window.renderMathInElement !== 'function') {
console.warn('æ•°å­¦å…¬å¼æ¸²æŸ“åº“æœªèƒ½æ­£å¸¸åŠ è½½');
}
}, 2000);

// é¡µé¢å¸è½½å‰æ¸…ç†çŠ¶æ€
window.addEventListener('beforeunload', function() {
  window.isAIResponding = false;
});

// é¡µé¢å¤±å»ç„¦ç‚¹æ—¶çš„å¤„ç†ï¼ˆæ¯”å¦‚ç”¨æˆ·åˆ‡æ¢åˆ°å…¶ä»–æ ‡ç­¾é¡µï¼‰
window.addEventListener('visibilitychange', function() {
  if (!document.hidden && window.isAIResponding) {
    // é¡µé¢é‡æ–°è·å¾—ç„¦ç‚¹æ—¶ï¼Œå¦‚æœçŠ¶æ€è¿˜æ˜¯å“åº”ä¸­ï¼Œç»™äºˆæç¤º
    console.log('é¡µé¢é‡æ–°è·å¾—ç„¦ç‚¹ï¼Œæ£€æŸ¥AIå“åº”çŠ¶æ€');
  }
});

// è°ƒè¯•åŠŸèƒ½ï¼šæ‰‹åŠ¨é‡ç½®çŠ¶æ€ï¼ˆåœ¨æ§åˆ¶å°ä¸­è°ƒç”¨ resetAIState()ï¼‰
window.resetAIState = function() {
  console.log('æ‰‹åŠ¨é‡ç½®AIå“åº”çŠ¶æ€');
  interruptAIResponse();
  showToast('AIçŠ¶æ€å·²é‡ç½®', 'success');
};

// è°ƒè¯•åŠŸèƒ½ï¼šæ‰‹åŠ¨æ¸²æŸ“æ•°å­¦å…¬å¼ï¼ˆåœ¨æ§åˆ¶å°ä¸­è°ƒç”¨ debugRenderMath()ï¼‰
window.debugRenderMath = function() {
  console.log('å¼€å§‹è°ƒè¯•æ•°å­¦å…¬å¼æ¸²æŸ“...');
  console.log('KaTeXçŠ¶æ€:', typeof window.katex);
  console.log('renderMathInElementçŠ¶æ€:', typeof window.renderMathInElement);
  
  // æŸ¥æ‰¾æ‰€æœ‰AIæ¶ˆæ¯å¹¶å°è¯•æ¸²æŸ“
  const aiMessages = document.querySelectorAll('.ai-content');
  console.log('æ‰¾åˆ°AIæ¶ˆæ¯æ•°é‡:', aiMessages.length);
  
  aiMessages.forEach((element, index) => {
    console.log(`æ¸²æŸ“æ¶ˆæ¯ ${index + 1}:`, element.innerHTML);
    renderMathSafely(element);
  });
  
  return 'æ•°å­¦å…¬å¼è°ƒè¯•å®Œæˆï¼ŒæŸ¥çœ‹æ§åˆ¶å°è¾“å‡º';
};
  // æŒ‰é’®åˆ‡æ¢åŠŸèƒ½
  searchToggle.addEventListener('click', function() {
    this.classList.toggle('active');
  });

  // è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬åŒºåŸŸé«˜åº¦
	messageInput.addEventListener('input', function() {
		this.style.height = 'auto';
		this.style.height = (this.scrollHeight > 48) ? this.scrollHeight + 'px' : '48px';
	});
// å‘é€æ¶ˆæ¯
sendButton.addEventListener('click', async function() {
// å¦‚æœAIæ­£åœ¨å“åº”ï¼Œè¿™ä¸ªæŒ‰é’®ç°åœ¨æ˜¯ä¸­æ–­æŒ‰é’®
if (window.isAIResponding) {
  console.log('ç”¨æˆ·ç‚¹å‡»ä¸­æ–­æŒ‰é’®ï¼Œåœæ­¢AIå“åº”');
  interruptAIResponse();
  showToast('å·²åœæ­¢AIå›å¤ï¼Œç°åœ¨å¯ä»¥å‘é€æ–°æ¶ˆæ¯', 'success');
  return; // åªä¸­æ–­ï¼Œä¸å‘é€æ¶ˆæ¯
}

// æ­£å¸¸å‘é€æ¶ˆæ¯æµç¨‹
const message = messageInput.value.trim();
if (!message) return;

console.log('å‘é€æ¶ˆæ¯:', message);
// ç«‹å³æ¸…ç©ºè¾“å…¥æ¡†å¹¶é‡ç½®é«˜åº¦
messageInput.value = '';
messageInput.style.height = '48px';

// éšè—æ¬¢è¿ä¿¡æ¯ï¼Œæ˜¾ç¤ºèŠå¤©å†…å®¹å’Œæ–°å¯¹è¯æŒ‰é’®
welcomeMessage.classList.add('hidden');
chatContent.classList.remove('hidden');
newChatButton.classList.remove('hidden');

// å‘é€æ¶ˆæ¯åˆ°åç«¯
await sendMessageToAPI(message);
});

// æŒ‰ Enter å‘é€æ¶ˆæ¯
messageInput.addEventListener('keydown', function(e) {
if (e.key === 'Enter' && !e.shiftKey) {
e.preventDefault();

// å¦‚æœAIæ­£åœ¨å“åº”ï¼Œæ˜¾ç¤ºä¸­æ–­æç¤º
if (window.isAIResponding) {
  console.log('AIæ­£åœ¨å“åº”ä¸­ï¼Œæ˜¾ç¤ºåœæ­¢æŒ‰é’®æç¤º');
  showInterruptHint();
  return;
}

// æ­£å¸¸æƒ…å†µä¸‹è§¦å‘å‘é€æŒ‰é’®
sendButton.click();
}
});

// å½•éŸ³æŒ‰é’®äº‹ä»¶ç›‘å¬
voiceButton.addEventListener('click', function() {
  if (isRecording) {
    stopRecording();
  } else {
    startRecording();
  }
});

// API äº¤äº’å‡½æ•°
window.currentChatId = null;
window.isAIResponding = false; // æ·»åŠ AIå“åº”çŠ¶æ€æ ‡è®°
window.currentStreamController = null; // å½“å‰æµå¼å“åº”æ§åˆ¶å™¨

// å½•éŸ³åŠŸèƒ½å˜é‡
let mediaRecorder = null;
let recordedChunks = [];
let isRecording = false;
let recordingStartTime = null;
let recognition = null; // Web Speech API

// å¹³æ»‘æ»šåŠ¨åˆ°åº•éƒ¨å‡½æ•°
function smoothScrollToBottom() {
const chatContainer = document.getElementById('chat-content');
if (!chatContainer) return;

// ä½¿ç”¨ scrollIntoView å®ç°å¹³æ»‘æ»šåŠ¨
const lastMessage = chatContainer.lastElementChild;
if (lastMessage) {
    lastMessage.scrollIntoView({ 
        behavior: 'smooth', 
        block: 'end',
        inline: 'nearest'
    });
} else {
    // å¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œç›´æ¥æ»šåŠ¨åˆ°åº•éƒ¨
    chatContainer.scrollTo({
        top: chatContainer.scrollHeight,
        behavior: 'smooth'
    });
}
}

// å¼ºåˆ¶æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆæ— åŠ¨ç”»ï¼Œç”¨äºåˆå§‹åŒ–ç­‰åœºæ™¯ï¼‰
function forceScrollToBottom() {
const chatContainer = document.getElementById('chat-content');
if (chatContainer) {
    chatContainer.scrollTop = chatContainer.scrollHeight;
}
}

// æ£€æŸ¥æ˜¯å¦éœ€è¦æ»šåŠ¨ï¼ˆç”¨äºä¼˜åŒ–æ€§èƒ½ï¼‰
function shouldAutoScroll() {
const chatContainer = document.getElementById('chat-content');
if (!chatContainer) return false;

// å¦‚æœç”¨æˆ·æ»šåŠ¨åˆ°æ¥è¿‘åº•éƒ¨ï¼ˆå®¹å·®50pxï¼‰ï¼Œåˆ™è®¤ä¸ºéœ€è¦è‡ªåŠ¨æ»šåŠ¨
const isNearBottom = chatContainer.scrollTop + chatContainer.clientHeight >= chatContainer.scrollHeight - 50;
return isNearBottom;
}

// æ™ºèƒ½æ»šåŠ¨ï¼šåªæœ‰å½“ç”¨æˆ·åœ¨åº•éƒ¨é™„è¿‘æ—¶æ‰è‡ªåŠ¨æ»šåŠ¨
function smartScrollToBottom() {
if (shouldAutoScroll()) {
    smoothScrollToBottom();
}
}

// ä¸­æ–­AIå“åº”å‡½æ•°
function interruptAIResponse() {
if (window.currentStreamController) {
  console.log('ä¸­æ–­å½“å‰AIæµå¼å“åº”');
  window.currentStreamController.abort();
  window.currentStreamController = null;
}
window.isAIResponding = false;
disableUserInput(false);
}

// å½•éŸ³åŠŸèƒ½å‡½æ•° - ä½¿ç”¨Web Speech API
function initializeSpeechRecognition() {
  try {
    // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
    if (!window.webkitSpeechRecognition && !window.SpeechRecognition) {
      console.warn('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«');
      return false;
    }
    
    // åˆ›å»ºè¯­éŸ³è¯†åˆ«å®ä¾‹
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    
    // é…ç½®è¯­éŸ³è¯†åˆ«
    recognition.continuous = false;  // ä¸è¿ç»­è¯†åˆ«
    recognition.interimResults = false;  // ä¸æ˜¾ç¤ºä¸­é—´ç»“æœ
    recognition.lang = 'zh-CN';  // é»˜è®¤ä¸­æ–‡ï¼Œä¹Ÿå¯ä»¥è‡ªåŠ¨è¯†åˆ«
    recognition.maxAlternatives = 1;  // æœ€å¤šè¿”å›1ä¸ªç»“æœ
    
    // ç›‘å¬è¯†åˆ«ç»“æœ
    recognition.onresult = function(event) {
      const result = event.results[0];
      if (result.isFinal) {
        const recognizedText = result[0].transcript;
        console.log('ğŸ¤ è¯­éŸ³è¯†åˆ«ç»“æœ:', recognizedText);
        handleSpeechResult(recognizedText);
      }
    };
    
    // ç›‘å¬è¯†åˆ«ç»“æŸ
    recognition.onend = function() {
      console.log('ğŸ¤ è¯­éŸ³è¯†åˆ«ç»“æŸ');
      isRecording = false;
      updateVoiceButtonState(false);
    };
    
    // ç›‘å¬è¯†åˆ«é”™è¯¯
    recognition.onerror = function(event) {
      console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
      isRecording = false;
      updateVoiceButtonState(false);
      
      let errorMessage = 'è¯­éŸ³è¯†åˆ«å¤±è´¥';
      switch(event.error) {
        case 'no-speech':
          errorMessage = 'æ²¡æœ‰æ£€æµ‹åˆ°è¯­éŸ³ï¼Œè¯·é‡è¯•';
          break;
        case 'audio-capture':
          errorMessage = 'æ— æ³•è®¿é—®éº¦å…‹é£';
          break;
        case 'not-allowed':
          errorMessage = 'éº¦å…‹é£æƒé™è¢«æ‹’ç»';
          break;
        case 'network':
          errorMessage = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥';
          break;
        default:
          errorMessage = `è¯­éŸ³è¯†åˆ«å¤±è´¥: ${event.error}`;
      }
      showToast(errorMessage, 'error');
    };
    
    // ç›‘å¬å¼€å§‹è¯†åˆ«
    recognition.onstart = function() {
      console.log('ğŸ¤ å¼€å§‹è¯­éŸ³è¯†åˆ«');
      isRecording = true;
      updateVoiceButtonState(true);
      showToast('è¯·è¯´è¯ï¼Œæ­£åœ¨å¬å–æ‚¨çš„è¯­éŸ³...', 'info');
    };
    
    return true;
  } catch (error) {
    console.error('åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«å¤±è´¥:', error);
    return false;
  }
}

function startRecording() {
  if (isRecording) {
    stopRecording();
    return;
  }
  
  if (!recognition) {
    const initialized = initializeSpeechRecognition();
    if (!initialized) {
      showToast('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½', 'error');
      return;
    }
  }
  
  try {
    console.log('ğŸ¤ å¯åŠ¨è¯­éŸ³è¯†åˆ«');
    recognition.start();
  } catch (error) {
    console.error('å¯åŠ¨è¯­éŸ³è¯†åˆ«å¤±è´¥:', error);
    showToast('è¯­éŸ³è¯†åˆ«å¯åŠ¨å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
  }
}

function stopRecording() {
  if (recognition && isRecording) {
    console.log('ğŸ¤ åœæ­¢è¯­éŸ³è¯†åˆ«');
    recognition.stop();
  }
}

function updateVoiceButtonState(recording) {
  const icon = voiceButton.querySelector('i');
  
  if (recording) {
    icon.className = 'ri-stop-circle-fill';
    voiceButton.classList.add('text-red-500', 'animate-pulse');
    voiceButton.classList.remove('text-gray-500');
    voiceButton.title = 'ç‚¹å‡»åœæ­¢å½•éŸ³';
  } else {
    icon.className = 'ri-mic-line';
    voiceButton.classList.remove('text-red-500', 'animate-pulse');
    voiceButton.classList.add('text-gray-500');
    voiceButton.title = 'ç‚¹å‡»å½•éŸ³';
  }
}

async function handleSpeechResult(recognizedText) {
  try {
    console.log('ğŸ¤ å¤„ç†è¯†åˆ«ç»“æœ:', recognizedText);
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯ä¸­æ–‡
    const isChinese = /[\u4e00-\u9fff]/.test(recognizedText);
    
    if (isChinese) {
      // å¦‚æœæ˜¯ä¸­æ–‡ï¼Œç›´æ¥ä½¿ç”¨
      showToast(`è¯†åˆ«æˆåŠŸ: ${recognizedText}`, 'success');
      messageInput.value = recognizedText;
    } else {
      // å¦‚æœä¸æ˜¯ä¸­æ–‡ï¼Œè°ƒç”¨ç¿»è¯‘API
      showToast('æ­£åœ¨ç¿»è¯‘ä¸ºä¸­æ–‡...', 'info');
      
      const response = await fetch('/api/voice/translate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          text: recognizedText
        })
      });
      
      const result = await response.json();
      
      if (result.success) {
        const translatedText = result.data.translatedText;
        showToast(`è¯†åˆ«å¹¶ç¿»è¯‘æˆåŠŸ: ${recognizedText} â†’ ${translatedText}`, 'success');
        messageInput.value = translatedText;
      } else {
        showToast(`è¯†åˆ«æˆåŠŸï¼Œç¿»è¯‘å¤±è´¥: ${recognizedText}`, 'warning');
        messageInput.value = recognizedText;
      }
    }
    
    // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
    messageInput.style.height = 'auto';
    messageInput.style.height = (messageInput.scrollHeight > 48) ? messageInput.scrollHeight + 'px' : '48px';
    
    // èšç„¦åˆ°è¾“å…¥æ¡†
    messageInput.focus();
    
  } catch (error) {
    console.error('å¤„ç†è¯­éŸ³ç»“æœæ—¶å‡ºé”™:', error);
    showToast('è¯­éŸ³å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
  }
}

async function sendMessageToAPI(message) {
try {
// å¦‚æœå·²ç»åœ¨å“åº”ä¸­ï¼Œå…ˆä¸­æ–­ä¹‹å‰çš„å“åº”
if (window.isAIResponding) {
  interruptAIResponse();
}

// è®¾ç½®å“åº”çŠ¶æ€
window.isAIResponding = true;
disableUserInput(true);

// åˆ›å»ºAbortControllerç”¨äºä¸­æ–­è¯·æ±‚
window.currentStreamController = new AbortController();

// è®¾ç½®è¶…æ—¶ä¿æŠ¤ï¼Œé˜²æ­¢ç•Œé¢æ°¸è¿œè¢«é”å®š
const responseTimeout = setTimeout(() => {
  if (window.isAIResponding) {
    console.log('AIå“åº”è¶…æ—¶ï¼Œé‡ç½®çŠ¶æ€');
    interruptAIResponse();
    showToast('AIå“åº”è¶…æ—¶ï¼Œè¯·é‡è¯•', 'error');
  }
}, 120000); // 2åˆ†é’Ÿè¶…æ—¶

// æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
displayUserMessage(message);

// æ˜¾ç¤ºAIæ¶ˆæ¯å ä½ç¬¦
const aiMessageElement = showTypingMessage();

// ä½¿ç”¨æµå¼æ¥å£
const response = await fetch('/api/chat/stream', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
},
body: JSON.stringify({
message: message,
      chatId: window.currentChatId,
useThinking: false,
useSearch: searchToggle.classList.contains('active')
}),
signal: window.currentStreamController.signal // æ·»åŠ ä¸­æ–­ä¿¡å·
});

if (!response.ok) {
throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
}

const reader = response.body.getReader();
const decoder = new TextDecoder();
let aiContent = '';

while (true) {
const { done, value } = await reader.read();
if (done) break;

const chunk = decoder.decode(value);
const lines = chunk.split('\n');

for (const line of lines) {
if (line.startsWith('data: ')) {
try {
const jsonStr = line.slice(6).trim();
if (jsonStr) {
const data = JSON.parse(jsonStr);
if (data.type === 'chatId') {
            // å¦‚æœè¿™æ˜¯ä¸€ä¸ªæ–°çš„èŠå¤©ï¼Œåˆ·æ–°å†å²è®°å½•
            const isNewChat = !window.currentChatId;
            window.currentChatId = data.chatId;
            if (isNewChat) {
              // å»¶è¿Ÿåˆ·æ–°å†å²è®°å½•ï¼Œç»™åç«¯ä¸€ç‚¹æ—¶é—´ä¿å­˜
              setTimeout(() => {
                loadChatHistory();
              }, 500);
            }
} else if (data.type === 'content') {
aiContent += data.content;
// å®ç°æ‰“å­—æœºæ•ˆæœ
typeWriterEffect(aiMessageElement, aiContent);
          } else if (data.type === 'end') {
            // æµå¼è¾“å‡ºç»“æŸï¼Œæ¸…ç†å…‰æ ‡
            finishTyping(aiMessageElement);
            // é‡ç½®å“åº”çŠ¶æ€ï¼Œå…è®¸ç”¨æˆ·å‘é€æ–°æ¶ˆæ¯
            window.isAIResponding = false;
            disableUserInput(false);
            window.currentStreamController = null;
            // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
            clearTimeout(responseTimeout);
            break;
          } else if (data.type === 'error') {
            showErrorMessage(data.error);
            // å‡ºé”™æ—¶ä¹Ÿè¦é‡ç½®çŠ¶æ€
            interruptAIResponse();
            // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
            clearTimeout(responseTimeout);
            return;
          }
}
} catch (e) {
console.log('è·³è¿‡æ— æ•ˆJSON:', line);
}
}
}
}

} catch (error) {
// æ£€æŸ¥æ˜¯å¦æ˜¯ç”¨æˆ·ä¸»åŠ¨ä¸­æ–­
if (error.name === 'AbortError') {
  console.log('ç”¨æˆ·ä¸­æ–­äº†AIå“åº”');
  return; // ä¸æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼Œå› ä¸ºæ˜¯ç”¨æˆ·ä¸»åŠ¨ä¸­æ–­
}

console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
showErrorMessage('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•');
// å‡ºé”™æ—¶é‡ç½®çŠ¶æ€
interruptAIResponse();
// æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
clearTimeout(responseTimeout);
}
}

function displayUserMessage(message) {
const chatContainer = document.getElementById('chat-content');
const now = new Date().toLocaleString('zh-CN');

// æ¸²æŸ“Markdownæ ¼å¼çš„ç”¨æˆ·æ¶ˆæ¯
const renderedMessage = renderMarkdown(message);

const userHTML = `
<div class="flex justify-end mb-4">
<div class="max-w-3xl">
<div class="flex justify-end mb-1">
<div class="text-sm text-gray-500">${now}</div>
</div>
<div class="relative group">
<div class="bg-gradient-to-br from-gray-100 via-gray-50 to-white rounded-lg py-3 px-4 text-gray-800 shadow-md hover:shadow-lg transition-shadow duration-300 markdown-content">
${renderedMessage}
</div>
</div>
</div>
</div>
`;

chatContainer.insertAdjacentHTML('beforeend', userHTML);

// æ¸²æŸ“æ•°å­¦å…¬å¼
const newMessage = chatContainer.querySelector('.markdown-content:last-of-type');
if (newMessage) {
renderMathSafely(newMessage);
}

// å¹³æ»‘æ»šåŠ¨åˆ°åº•éƒ¨
smoothScrollToBottom();
}

function showTypingMessage() {
const chatContainer = document.getElementById('chat-content');
const now = new Date().toLocaleString('zh-CN');

const typingHTML = `
<div class="flex justify-start ai-message">
<div class="max-w-3xl">
<div class="flex items-center gap-2 mb-1">
<div class="font-medium">AIå°å­</div>
<div class="text-sm text-gray-500">${now}</div>
</div>
<div class="bg-[#F7F8FA] rounded-lg py-3 px-4 text-gray-800 min-h-[1.5rem] markdown-content">
<span class="ai-content"></span>
<span class="typing-cursor">|</span>
</div>
</div>
</div>
`;

chatContainer.insertAdjacentHTML('beforeend', typingHTML);
// å¹³æ»‘æ»šåŠ¨åˆ°åº•éƒ¨
smoothScrollToBottom();

// æ·»åŠ å…‰æ ‡é—ªçƒæ•ˆæœï¼ˆä½¿ç”¨CSSåŠ¨ç”»ï¼‰
const cursor = chatContainer.querySelector('.ai-message:last-child .typing-cursor');

// è¿”å›æ¶ˆæ¯å…ƒç´ 
const messageElement = chatContainer.querySelector('.ai-message:last-child .ai-content');
return messageElement;
}

function typeWriterEffect(element, fullText) {
// æ¸²æŸ“Markdownå¹¶æ›´æ–°å†…å®¹
const renderedText = renderMarkdown(fullText);
element.innerHTML = renderedText;

// æ¸²æŸ“æ•°å­¦å…¬å¼ï¼ˆåå°æ¸²æŸ“ï¼Œæ— é—ªåŠ¨ï¼‰
setTimeout(() => {
    renderMathSafely(element);
    // æ•°å­¦å…¬å¼æ¸²æŸ“å®Œæˆåæ™ºèƒ½æ»šåŠ¨
    setTimeout(() => smartScrollToBottom(), 100);
}, 50);

// ä½¿ç”¨æ™ºèƒ½æ»šåŠ¨ï¼šåªæœ‰å½“ç”¨æˆ·åœ¨åº•éƒ¨é™„è¿‘æ—¶æ‰è‡ªåŠ¨æ»šåŠ¨
smartScrollToBottom();
}

function finishTyping(element) {
// æ¸…ç†å…‰æ ‡
const cursor = element.parentElement.querySelector('.typing-cursor');
if (cursor) {
cursor.style.display = 'none';
}

// å®Œæˆæ‰“å­—åæ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆæ•°å­¦å…¬å¼å·²åœ¨typeWriterEffectä¸­æ¸²æŸ“ï¼‰
setTimeout(() => {
    smoothScrollToBottom();
}, 100);
}

// æ˜¾ç¤ºä¸­æ–­æç¤º
function showInterruptHint() {
const sendButton = document.getElementById('send-button'); // ä¿®æ­£ï¼šä½¿ç”¨IDé€‰æ‹©å™¨
if (!sendButton) return;

// åˆ›å»ºæç¤ºæ¡†
const hint = document.createElement('div');
hint.className = 'interrupt-hint fixed z-50 bg-gray-800 text-white px-3 py-2 rounded-lg shadow-xl font-medium text-center';
hint.innerHTML = `
  <div class="flex items-center justify-center">
    <i class="ri-arrow-down-line mr-1 text-sm"></i>
    <span class="text-sm">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¯åœæ­¢AIå¯¹è¯</span>
  </div>
`;
hint.style.cssText = `
  animation: bounce-in 0.3s ease-out;
  pointer-events: none;
`;

// è·å–å‘é€æŒ‰é’®çš„ä½ç½®ï¼Œæç¤ºæ˜¾ç¤ºåœ¨æŒ‰é’®ä¸Šæ–¹
const buttonRect = sendButton.getBoundingClientRect();
hint.style.position = 'fixed';
hint.style.left = (buttonRect.left + buttonRect.width/2 - 120) + 'px'; // å±…ä¸­å¯¹é½
hint.style.top = (buttonRect.top - 70) + 'px'; // åœ¨æŒ‰é’®ä¸Šæ–¹

document.body.appendChild(hint);

// è®©ä¸­æ–­æŒ‰é’®é—ªçƒæé†’
sendButton.classList.add('animate-pulse');
setTimeout(() => {
  sendButton.classList.remove('animate-pulse');
}, 2000);

// 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
setTimeout(() => {
  if (document.body.contains(hint)) {
    hint.style.animation = 'fade-out 0.3s ease-in';
    setTimeout(() => {
      if (document.body.contains(hint)) {
        document.body.removeChild(hint);
      }
    }, 300);
  }
}, 3000);

// æ’­æ”¾è½»å¾®çš„éœ‡åŠ¨æ•ˆæœï¼ˆå¦‚æœæ”¯æŒï¼‰
if (navigator.vibrate) {
  navigator.vibrate(100);
}
}

// æ§åˆ¶ç”¨æˆ·è¾“å…¥çŠ¶æ€
function disableUserInput(disabled) {
const messageInput = document.querySelector('.message-input');
const sendButton = document.getElementById('send-button'); // ä¿®æ­£ï¼šä½¿ç”¨IDé€‰æ‹©å™¨
const searchToggle = document.getElementById('search-toggle');

if (disabled) {
  // ä¸ç¦ç”¨è¾“å…¥æ¡†ï¼Œåªæ”¹å˜å¤–è§‚æç¤ºç”¨æˆ·AIæ­£åœ¨å“åº”
  messageInput.placeholder = 'å’ŒAIå°å­èŠå¤©å§...'; // ä¿æŒæ­£å¸¸æç¤ºæ–‡å­—
  
  // æ·»åŠ è¾¹æ¡†åŠ¨ç”»æ•ˆæœæç¤ºAIæ­£åœ¨å“åº”
  messageInput.style.borderColor = '#3B82F6';
  messageInput.style.boxShadow = '0 0 0 2px rgba(59, 130, 246, 0.1)';
  messageInput.style.animation = 'pulse-border 2s infinite';
  
  if (sendButton) {
    // ä¿®æ”¹ä¸ºåœæ­¢æŒ‰é’®çš„æ ·å¼
    const sendIcon = sendButton.querySelector('i');
    if (sendIcon) {
      sendIcon.className = 'ri-stop-circle-fill'; // ä½¿ç”¨å®å¿ƒåœæ­¢å›¾æ ‡
    }
    sendButton.title = 'ç‚¹å‡»åœæ­¢AIå›å¤';
    // ä¿æŒè“è‰²èƒŒæ™¯ï¼Œåªæ”¹å˜å›¾æ ‡
  }
  
  // åˆ‡æ¢æŒ‰é’®ä¿æŒå¯ç”¨ä½†æ·»åŠ æç¤º
  if (searchToggle) {
    searchToggle.title = 'AIå“åº”ä¸­ï¼Œæ–°æ¶ˆæ¯ç”Ÿæ•ˆ';
  }
} else {
  // æ¢å¤æ­£å¸¸çŠ¶æ€
  messageInput.placeholder = 'å’ŒAIå°å­èŠå¤©å§...';
  
  // ç§»é™¤åŠ¨ç”»æ•ˆæœ
  messageInput.style.borderColor = '';
  messageInput.style.boxShadow = '';
  messageInput.style.animation = '';
  
  if (sendButton) {
    // æ¢å¤å‘é€æŒ‰é’®
    const sendIcon = sendButton.querySelector('i');
    if (sendIcon) {
      sendIcon.className = 'ri-send-plane-fill';
    }
    sendButton.title = 'å‘é€æ¶ˆæ¯';
    // åªéœ€è¦æ¢å¤å›¾æ ‡ï¼ŒèƒŒæ™¯è‰²ä¿æŒä¸å˜
  }
  
  // æ¢å¤åˆ‡æ¢æŒ‰é’®æç¤º
  if (searchToggle) {
    searchToggle.title = 'å¼€å¯è”ç½‘æœç´¢';
  }
}
}

// æ—§çš„displayMessageså‡½æ•°å·²è¢«æµå¼æ˜¾ç¤ºæ›¿ä»£

function showErrorMessage(error) {
// ç§»é™¤åŠ è½½æ¶ˆæ¯
const loadingMessage = document.querySelector('.loading-message');
if (loadingMessage) {
loadingMessage.remove();
}

const chatContainer = document.getElementById('chat-content');
const errorHTML = `
<div class="flex justify-start">
<div class="max-w-3xl">
<div class="flex items-center gap-2 mb-1">
<div class="font-medium">AIå°å­</div>
<div class="text-sm text-gray-500">${new Date().toLocaleString('zh-CN')}</div>
</div>
<div class="bg-red-50 border border-red-200 rounded-lg py-3 px-4 text-red-800">
âŒ ${error}
</div>
</div>
</div>
`;
chatContainer.insertAdjacentHTML('beforeend', errorHTML);
// å¹³æ»‘æ»šåŠ¨åˆ°åº•éƒ¨
smoothScrollToBottom();
}

function bindThinkingToggle() {
document.querySelectorAll('.thinking-toggle').forEach(button => {
button.addEventListener('click', function() {
const thinkingProcess = this.nextElementSibling;
thinkingProcess.classList.toggle('expanded');
// æ›´æ–°ç®­å¤´å›¾æ ‡
const arrowIcon = this.querySelector('.ri-arrow-down-s-line, .ri-arrow-up-s-line');
if (thinkingProcess.classList.contains('expanded')) {
arrowIcon.classList.replace('ri-arrow-down-s-line', 'ri-arrow-up-s-line');
} else {
arrowIcon.classList.replace('ri-arrow-up-s-line', 'ri-arrow-down-s-line');
}
});
});
}

// åŠ è½½èŠå¤©å†å²
async function loadChatHistory() {
try {
const response = await fetch('/api/chat/history');
const result = await response.json();
if (result.success) {
updateHistoryList(result.data);
}
} catch (error) {
console.error('åŠ è½½å†å²å¤±è´¥:', error);
}
}

function updateHistoryList(history) {
const historyContainer = document.getElementById('history-container');

if (!history || (Object.keys(history).length === 0 && 
    (!history['å½“å¤©'] || history['å½“å¤©'].length === 0) &&
    (!history['ä¸ƒå¤©ä»¥å†…'] || history['ä¸ƒå¤©ä»¥å†…'].length === 0) &&
    (!history['ä¸€ä¸ªæœˆä»¥å†…'] || history['ä¸€ä¸ªæœˆä»¥å†…'].length === 0) &&
    (!history['æ›´æ—©'] || Object.keys(history['æ›´æ—©']).length === 0))) {
  historyContainer.innerHTML = `
    <div class="p-3 text-center text-gray-500 text-sm">
      <i class="ri-chat-3-line mr-1"></i>
      æš‚æ— å†å²å¯¹è¯
    </div>
  `;
  return;
}

let historyHTML = '';

// å½“å¤©
if (history['å½“å¤©'] && history['å½“å¤©'].length > 0) {
  historyHTML += `
    <div class="p-3">
      <div class="text-sm text-gray-500 mb-2 flex items-center gap-1">
        <i class="ri-time-line"></i>
        å½“å¤©
      </div>
      ${history['å½“å¤©'].map((chat, index) => `
        <div class="history-item py-2 px-3 rounded text-sm mb-1 cursor-pointer hover:bg-gray-50 ${index === 0 ? 'active-chat bg-blue-50 text-blue-700' : ''}" data-chat-id="${chat.id}">
          <div class="flex items-center justify-between group">
            <div class="truncate flex-1 pr-2">${chat.title}</div>
            <div class="opacity-0 group-hover:opacity-100 transition-opacity">
              <button class="delete-chat-btn w-6 h-6 flex items-center justify-center text-red-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors" data-chat-id="${chat.id}" title="åˆ é™¤å¯¹è¯">
                <i class="ri-delete-bin-line text-xs"></i>
              </button>
            </div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
}

// ä¸ƒå¤©ä»¥å†…
if (history['ä¸ƒå¤©ä»¥å†…'] && history['ä¸ƒå¤©ä»¥å†…'].length > 0) {
  historyHTML += `
    <div class="p-3">
      <div class="text-sm text-gray-500 mb-2 flex items-center gap-1">
        <i class="ri-calendar-line"></i>
        ä¸ƒå¤©ä»¥å†…
      </div>
      ${history['ä¸ƒå¤©ä»¥å†…'].map(chat => `
        <div class="history-item py-2 px-3 rounded text-sm mb-1 cursor-pointer hover:bg-gray-50" data-chat-id="${chat.id}">
          <div class="flex items-center justify-between group">
            <div class="truncate flex-1 pr-2">${chat.title}</div>
            <div class="opacity-0 group-hover:opacity-100 transition-opacity">
              <button class="delete-chat-btn w-6 h-6 flex items-center justify-center text-red-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors" data-chat-id="${chat.id}" title="åˆ é™¤å¯¹è¯">
                <i class="ri-delete-bin-line text-xs"></i>
              </button>
            </div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
}

// ä¸€ä¸ªæœˆä»¥å†…
if (history['ä¸€ä¸ªæœˆä»¥å†…'] && history['ä¸€ä¸ªæœˆä»¥å†…'].length > 0) {
  historyHTML += `
    <div class="p-3">
      <div class="text-sm text-gray-500 mb-2 flex items-center gap-1">
        <i class="ri-calendar-2-line"></i>
        ä¸€ä¸ªæœˆä»¥å†…
      </div>
      ${history['ä¸€ä¸ªæœˆä»¥å†…'].map(chat => `
        <div class="history-item py-2 px-3 rounded text-sm mb-1 cursor-pointer hover:bg-gray-50" data-chat-id="${chat.id}">
          <div class="flex items-center justify-between group">
            <div class="truncate flex-1 pr-2">${chat.title}</div>
            <div class="opacity-0 group-hover:opacity-100 transition-opacity">
              <button class="delete-chat-btn w-6 h-6 flex items-center justify-center text-red-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors" data-chat-id="${chat.id}" title="åˆ é™¤å¯¹è¯">
                <i class="ri-delete-bin-line text-xs"></i>
              </button>
            </div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
}

// æ›´æ—©çš„å¯¹è¯ï¼ˆæŒ‰æœˆä»½åˆ†ç»„ï¼‰
if (history['æ›´æ—©'] && Object.keys(history['æ›´æ—©']).length > 0) {
  Object.keys(history['æ›´æ—©']).sort().reverse().forEach(monthKey => {
    if (history['æ›´æ—©'][monthKey] && history['æ›´æ—©'][monthKey].length > 0) {
      historyHTML += `
        <div class="p-3">
          <div class="text-sm text-gray-500 mb-2 flex items-center gap-1">
            <i class="ri-history-line"></i>
            ${monthKey}
          </div>
          ${history['æ›´æ—©'][monthKey].map(chat => `
            <div class="history-item py-2 px-3 rounded text-sm mb-1 cursor-pointer hover:bg-gray-50" data-chat-id="${chat.id}">
              <div class="flex items-center justify-between group">
                <div class="truncate flex-1 pr-2">${chat.title}</div>
                <div class="opacity-0 group-hover:opacity-100 transition-opacity">
                  <button class="delete-chat-btn w-6 h-6 flex items-center justify-center text-red-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors" data-chat-id="${chat.id}" title="åˆ é™¤å¯¹è¯">
                    <i class="ri-delete-bin-line text-xs"></i>
                  </button>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }
  });
}

if (historyHTML === '') {
  historyHTML = `
    <div class="p-3 text-center text-gray-500 text-sm">
      <i class="ri-chat-3-line mr-1"></i>
      æš‚æ— å†å²å¯¹è¯
    </div>
  `;
}

historyContainer.innerHTML = historyHTML;

// ç»‘å®šç‚¹å‡»äº‹ä»¶
bindHistoryItemEvents();
}

// ç»‘å®šå†å²è®°å½•é¡¹ç‚¹å‡»äº‹ä»¶
function bindHistoryItemEvents() {
const historyItems = document.querySelectorAll('.history-item');
const deleteButtons = document.querySelectorAll('.delete-chat-btn');

// ç»‘å®šå†å²é¡¹ç‚¹å‡»äº‹ä»¶
historyItems.forEach(item => {
  item.addEventListener('click', async function(e) {
    // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ é™¤æŒ‰é’®ï¼Œä¸æ‰§è¡Œå†å²é¡¹ç‚¹å‡»é€»è¾‘
    if (e.target.closest('.delete-chat-btn')) {
      return;
    }
    
    // ç§»é™¤æ‰€æœ‰æ´»è·ƒçŠ¶æ€
    historyItems.forEach(i => i.classList.remove('active-chat'));
    // æ·»åŠ å½“å‰é¡¹çš„æ´»è·ƒçŠ¶æ€
    this.classList.add('active-chat');
    
    // è·å–èŠå¤©ID
    const chatId = this.getAttribute('data-chat-id');
    if (chatId) {
      await loadChatMessages(chatId);
    }
    
    // æ˜¾ç¤ºèŠå¤©å†…å®¹åŒºåŸŸ
    document.getElementById('welcome-message').classList.add('hidden');
    document.getElementById('chat-content').classList.remove('hidden');
    document.getElementById('new-chat-button').classList.remove('hidden');
  });
});

// ç»‘å®šåˆ é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
deleteButtons.forEach(button => {
  button.addEventListener('click', async function(e) {
    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
    
    const chatId = this.getAttribute('data-chat-id');
    const historyItem = this.closest('.history-item');
    const chatTitle = historyItem.querySelector('.truncate').textContent;
    
    // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    if (await showDeleteConfirmation(chatTitle)) {
      await deleteChatById(chatId);
    }
  });
});
}

// åŠ è½½ç‰¹å®šèŠå¤©çš„æ¶ˆæ¯
async function loadChatMessages(chatId) {
try {
  const response = await fetch(`/api/chat/${chatId}`);
  const result = await response.json();
  if (result.success) {
    displayChatMessages(result.data.messages);
    // è®¾ç½®å½“å‰èŠå¤©ID
    window.currentChatId = chatId;
  }
} catch (error) {
  console.error('åŠ è½½èŠå¤©æ¶ˆæ¯å¤±è´¥:', error);
  showErrorMessage('åŠ è½½èŠå¤©è®°å½•å¤±è´¥');
}
}

// æ˜¾ç¤ºèŠå¤©æ¶ˆæ¯ - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œå‡å°‘é‡å¤æ¸²æŸ“
function displayChatMessages(messages) {
const chatContent = document.getElementById('chat-content');
chatContent.innerHTML = '';

// æ ‡è®°æ­£åœ¨åŠ è½½å†å²æ¶ˆæ¯
window.isLoadingHistory = true;

messages.forEach(message => {
  if (message.role === 'user') {
    displayUserMessage(message.content);
  } else if (message.role === 'assistant') {
    displayAssistantMessage(message.content, message.thinking, message.searchUsed, message.searchResultsCount);
  }
});

// æ ‡è®°å†å²æ¶ˆæ¯åŠ è½½å®Œæˆ
window.isLoadingHistory = false;

// æ‰¹é‡æ¸²æŸ“æ‰€æœ‰æ•°å­¦å…¬å¼
setTimeout(() => {
    const mathElements = chatContent.querySelectorAll('.markdown-content');
    mathElements.forEach(element => {
      renderMathSafely(element);
    });
    
    // æ•°å­¦å…¬å¼æ¸²æŸ“å®Œæˆåæ»šåŠ¨åˆ°åº•éƒ¨
    setTimeout(() => smoothScrollToBottom(), 300);
}, 150);
}

// æ˜¾ç¤ºåŠ©æ‰‹æ¶ˆæ¯
function displayAssistantMessage(content, thinking, searchUsed, searchResultsCount) {
const chatContainer = document.getElementById('chat-content');
const now = new Date().toLocaleString('zh-CN');

// æ¸²æŸ“Markdownæ ¼å¼çš„åŠ©æ‰‹æ¶ˆæ¯
const renderedMessage = renderMarkdown(content);

let thinkingHTML = '';
if (thinking) {
  thinkingHTML = `
    <div class="mb-3">
      <button class="thinking-toggle flex items-center gap-2 text-sm text-blue-600 hover:text-blue-700 bg-blue-50 hover:bg-blue-100 px-3 py-1.5 rounded-lg transition-colors">
        <i class="ri-brain-line"></i>
        <span>æ€è€ƒè¿‡ç¨‹</span>
        <i class="ri-arrow-down-s-line"></i>
      </button>
      <div class="thinking-process mt-2 bg-blue-50 rounded-lg p-3 text-sm text-blue-800">
        ${thinking.content}
      </div>
    </div>
  `;
}

let searchHTML = '';
if (searchUsed) {
  searchHTML = `
    <div class="mb-3 text-xs text-gray-500 flex items-center gap-1">
      <i class="ri-search-line"></i>
      <span>å·²è”ç½‘æœç´¢${searchResultsCount ? ` (${searchResultsCount}æ¡ç»“æœ)` : ''}</span>
    </div>
  `;
}

const assistantHTML = `
  <div class="flex justify-start ai-message">
    <div class="max-w-3xl">
      <div class="flex items-center gap-2 mb-1">
        <div class="font-medium">AIå°å­</div>
        <div class="text-sm text-gray-500">${now}</div>
      </div>
      ${thinkingHTML}
      ${searchHTML}
      <div class="bg-[#F7F8FA] rounded-lg py-3 px-4 text-gray-800 markdown-content">
        ${renderedMessage}
      </div>
    </div>
  </div>
`;

chatContainer.insertAdjacentHTML('beforeend', assistantHTML);

// æ¸²æŸ“æ•°å­¦å…¬å¼
const newMessage = chatContainer.querySelector('.ai-message:last-child .markdown-content');
if (newMessage) {
  renderMathSafely(newMessage);
}

// åªæœ‰å®æ—¶æ¶ˆæ¯æ‰éœ€è¦ç«‹å³æ»šåŠ¨
const isLiveMessage = !window.isLoadingHistory;
if (isLiveMessage) {
  smoothScrollToBottom();
}

// ç»‘å®šæ€è€ƒè¿‡ç¨‹åˆ‡æ¢äº‹ä»¶
bindThinkingToggle();
}

// æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
function showDeleteConfirmation(chatTitle) {
return new Promise((resolve) => {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-md mx-4 modal-enter">
      <div class="flex items-center mb-4">
        <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center mr-3">
          <i class="ri-delete-bin-line text-red-600"></i>
        </div>
        <h3 class="text-lg font-semibold text-gray-900">åˆ é™¤å¯¹è¯</h3>
      </div>
      <p class="text-gray-600 mb-6">
        ç¡®å®šè¦åˆ é™¤å¯¹è¯ "<span class="font-medium">${chatTitle}</span>" å—ï¼Ÿ<br>
        <span class="text-sm text-red-500">æ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</span>
      </p>
      <div class="flex justify-end gap-3">
        <button class="cancel-btn px-4 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors">
          å–æ¶ˆ
        </button>
        <button class="confirm-btn px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
          åˆ é™¤
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // ç»‘å®šäº‹ä»¶
  modal.querySelector('.cancel-btn').addEventListener('click', () => {
    document.body.removeChild(modal);
    resolve(false);
  });
  
  modal.querySelector('.confirm-btn').addEventListener('click', () => {
    document.body.removeChild(modal);
    resolve(true);
  });
  
  // ç‚¹å‡»èƒŒæ™¯å…³é—­
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      document.body.removeChild(modal);
      resolve(false);
    }
  });
  
  // ESCé”®å…³é—­
  const handleEscape = (e) => {
    if (e.key === 'Escape') {
      document.body.removeChild(modal);
      document.removeEventListener('keydown', handleEscape);
      resolve(false);
    }
  };
  document.addEventListener('keydown', handleEscape);
});
}

// åˆ é™¤èŠå¤©
async function deleteChatById(chatId) {
try {
  // æ˜¾ç¤ºåˆ é™¤loadingçŠ¶æ€
  const historyItem = document.querySelector(`[data-chat-id="${chatId}"]`);
  const deleteBtn = historyItem.querySelector('.delete-chat-btn');
  const originalContent = deleteBtn.innerHTML;
  deleteBtn.innerHTML = '<i class="ri-loader-4-line animate-spin text-xs"></i>';
  deleteBtn.disabled = true;
  
  const response = await fetch(`/api/chat/${chatId}`, {
    method: 'DELETE'
  });
  
  const result = await response.json();
  
  if (result.success) {
    // åˆ é™¤æˆåŠŸï¼Œåˆ·æ–°å†å²è®°å½•
    await loadChatHistory();
    
    // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ­£åœ¨æŸ¥çœ‹çš„èŠå¤©ï¼Œå›åˆ°æ¬¢è¿é¡µé¢
    if (window.currentChatId === chatId) {
      startNewChat();
    }
    
    // æ˜¾ç¤ºæˆåŠŸæç¤º
    showToast('å¯¹è¯åˆ é™¤æˆåŠŸ', 'success');
  } else {
    throw new Error(result.error || 'åˆ é™¤å¤±è´¥');
  }
  
} catch (error) {
  console.error('åˆ é™¤èŠå¤©å¤±è´¥:', error);
  
  // æ¢å¤åˆ é™¤æŒ‰é’®çŠ¶æ€
  const historyItem = document.querySelector(`[data-chat-id="${chatId}"]`);
  if (historyItem) {
    const deleteBtn = historyItem.querySelector('.delete-chat-btn');
    deleteBtn.innerHTML = '<i class="ri-delete-bin-line text-xs"></i>';
    deleteBtn.disabled = false;
  }
  
  showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
}
}

// æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
function showToast(message, type = 'info') {
const toast = document.createElement('div');
toast.className = `toast fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full ${
  type === 'success' ? 'bg-green-500 text-white' :
  type === 'error' ? 'bg-red-500 text-white' :
  'bg-blue-500 text-white'
}`;
toast.textContent = message;

document.body.appendChild(toast);

// æ˜¾ç¤ºåŠ¨ç”»
requestAnimationFrame(() => {
  toast.style.transform = 'translateX(0)';
});

// 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
setTimeout(() => {
  toast.style.transform = 'translateX(full)';
  setTimeout(() => {
    if (document.body.contains(toast)) {
      document.body.removeChild(toast);
    }
  }, 300);
}, 3000);
}

// å¼€å§‹æ–°å¯¹è¯
async function startNewChat() {
try {
  // å¦‚æœå½“å‰æœ‰æ­£åœ¨è¿›è¡Œçš„å¯¹è¯ï¼Œå…ˆç¡®ä¿å®ƒå·²ç»ä¿å­˜
  if (window.currentChatId) {
    console.log('ä¿å­˜å½“å‰å¯¹è¯åˆ°å†å²è®°å½•:', window.currentChatId);
    
    // ç»™æœåŠ¡å™¨ä¸€ç‚¹æ—¶é—´ç¡®ä¿æœ€åçš„æ¶ˆæ¯å·²ç»ä¿å­˜
    await new Promise(resolve => setTimeout(resolve, 100));
    
    // åˆ·æ–°å†å²è®°å½•ä»¥æ˜¾ç¤ºåˆšä¿å­˜çš„å¯¹è¯
    await loadChatHistory();
  }
  
  // ç§»é™¤æ‰€æœ‰å†å²é¡¹çš„æ´»è·ƒçŠ¶æ€
const historyItems = document.querySelectorAll('.history-item');
historyItems.forEach(i => i.classList.remove('active-chat'));

  // æ¸…ç©ºèŠå¤©å†…å®¹åŒºåŸŸï¼Œç¡®ä¿åªæ˜¾ç¤ºæ–°å¯¹è¯
  const chatContent = document.getElementById('chat-content');
  chatContent.innerHTML = ''; // æ¸…ç©ºæ‰€æœ‰ä¹‹å‰çš„èŠå¤©æ¶ˆæ¯
  
  // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯ï¼Œéšè—èŠå¤©å†…å®¹å’Œæ–°å¯¹è¯æŒ‰é’®
document.getElementById('welcome-message').classList.remove('hidden');
document.getElementById('chat-content').classList.add('hidden');
document.getElementById('new-chat-button').classList.add('hidden');

  // æ¸…ç©ºè¾“å…¥æ¡†
  const messageInput = document.querySelector('.message-input');
messageInput.value = '';
messageInput.style.height = '48px';
messageInput.focus();

  // æ¸…é™¤å½“å‰èŠå¤©ID
  const previousChatId = window.currentChatId;
  window.currentChatId = null;

  // æ·»åŠ åŠ¨ç”»æ•ˆæœ
const welcomeDiv = document.getElementById('welcome-message');
welcomeDiv.style.opacity = '0';
welcomeDiv.style.transform = 'translateY(20px)';
requestAnimationFrame(() => {
welcomeDiv.style.transition = 'all 0.5s ease';
welcomeDiv.style.opacity = '1';
welcomeDiv.style.transform = 'translateY(0)';
});
  
  // å¦‚æœæœ‰ä¹‹å‰çš„å¯¹è¯ï¼Œæ˜¾ç¤ºæç¤º
  if (previousChatId) {
    showToast('å½“å‰å¯¹è¯å·²ä¿å­˜åˆ°å†å²è®°å½•', 'success');
  }
  
} catch (error) {
  console.error('å¼€å¯æ–°å¯¹è¯æ—¶å‡ºé”™:', error);
  // å³ä½¿å‡ºé”™ä¹Ÿè¦å…è®¸ç”¨æˆ·å¼€å¯æ–°å¯¹è¯
  window.currentChatId = null;
  showToast('å¼€å¯æ–°å¯¹è¯', 'info');
}
}

// åœ¨ç¬¬ä¸€ä¸ªDOMContentLoadedä¸­æ·»åŠ æ–°å¯¹è¯æŒ‰é’®äº‹ä»¶ç»‘å®š
// é¡µé¢åŠ è½½æ—¶è·å–å†å²å¹¶ç»‘å®šæŒ‰é’®äº‹ä»¶
setTimeout(() => {
  loadChatHistory();
  
  // åˆå§‹åŒ–çŠ¶æ€
  window.isAIResponding = false;
  disableUserInput(false);
  
  // æ–°å¯¹è¯æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - ä½¿ç”¨ç±»åé€‰æ‹©å™¨
  const newChatButtons = document.querySelectorAll('.new-chat-btn');
  newChatButtons.forEach(button => {
    button.addEventListener('click', async function(e) {
      e.preventDefault();
      console.log('æ–°å¯¹è¯æŒ‰é’®è¢«ç‚¹å‡»');
      
      // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
      this.disabled = true;
      const originalText = this.querySelector('span').textContent;
      this.querySelector('span').textContent = 'ä¿å­˜ä¸­...';
      
      try {
        await startNewChat();
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        this.disabled = false;
        this.querySelector('span').textContent = originalText;
      }
});
});

  // ä¹Ÿå¯ä»¥é€šè¿‡IDå•ç‹¬ç»‘å®š
  const sidebarNewChatBtn = document.getElementById('sidebar-new-chat-btn');
  const chatNewChatBtn = document.getElementById('chat-new-chat-btn');

  if (sidebarNewChatBtn) {
    sidebarNewChatBtn.addEventListener('click', async function(e) {
      e.preventDefault();
      console.log('ä¾§è¾¹æ æ–°å¯¹è¯æŒ‰é’®è¢«ç‚¹å‡»');
      
      // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
      this.disabled = true;
      const originalText = this.querySelector('span').textContent;
      this.querySelector('span').textContent = 'ä¿å­˜ä¸­...';
      
      try {
        await startNewChat();
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        this.disabled = false;
        this.querySelector('span').textContent = originalText;
      }
    });
  }

  if (chatNewChatBtn) {
    chatNewChatBtn.addEventListener('click', async function(e) {
      e.preventDefault();
      console.log('èŠå¤©åŒºåŸŸæ–°å¯¹è¯æŒ‰é’®è¢«ç‚¹å‡»');
      
      // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
      this.disabled = true;
      const originalText = this.querySelector('span').textContent;
      this.querySelector('span').textContent = 'ä¿å­˜ä¸­...';
      
      try {
        await startNewChat();
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        this.disabled = false;
        this.querySelector('span').textContent = originalText;
      }
    });
  }
}, 100);

}); // ç»“æŸç¬¬ä¸€ä¸ªDOMContentLoaded
</script>
</body>
</html>