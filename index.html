<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title> AI å°å­</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com/3.4.16"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6',
            secondary: '#6B7280'
          },
          borderRadius: {
            'none': '0px',
            'sm': '4px',
            DEFAULT: '8px',
            'md': '12px',
            'lg': '16px',
            'xl': '20px',
            '2xl': '24px',
            '3xl': '32px',
            'full': '9999px',
            'button': '8px'
          }
        }
      }
    }
  </script>
  <style>
    /* ç§»é™¤å¼ºåˆ¶å›¾æ ‡å†…å®¹ï¼Œè®©å›¾æ ‡æ­£å¸¸æ˜¾ç¤º */

    /* é¡µé¢åŸºç¡€æ ·å¼ - ç§»é™¤é»˜è®¤è¾¹è·å’Œè®¾ç½®å…¨é«˜åº¦ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      min-height: 100vh;
      overflow: hidden;
    }

    .chat-container {
      height: calc(100vh - 80px);
    }

    .chat-messages {
      scroll-behavior: smooth;
    }

    .message-input:focus {
      outline: none;
    }

    .history-item {
      transition: all 0.2s ease;
    }

    .history-item:hover {
      background-color: rgb(239 246 255);
      color: rgb(37 99 235);
    }

    .active-chat {
      background: rgb(239 246 255);
      color: rgb(37 99 235);
    }

    .active-chat:hover {
      background: rgb(219 234 254);
      color: rgb(29 78 216);
      transform: none;
    }

    .thinking-process {
      max-height: 0;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .thinking-process.expanded {
      max-height: 500px;
    }

    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background-color: #E5E7EB;
      border-radius: 20px;
    }

    .glass-effect {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(16px);
      box-shadow:
        0 8px 32px rgba(0, 0, 0, 0.03),
        0 1px 2px rgba(255, 255, 255, 0.2) inset,
        0 -1px 2px rgba(0, 0, 0, 0.03) inset;
      border: 1px solid rgba(255, 255, 255, 0.4);
    }

    .message-input {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .message-input:focus {
      background-color: white;
      box-shadow:
        0 4px 12px rgba(59, 130, 246, 0.08),
        0 2px 4px rgba(59, 130, 246, 0.03);
      border: 1px solid rgba(59, 130, 246, 0.1);
    }

    .button-hover-effect {
      transition: all 0.2s ease;
    }

    .button-hover-effect:hover {
      transform: translateY(-2px);
      box-shadow:
        0 4px 16px rgba(59, 130, 246, 0.25),
        0 2px 4px rgba(59, 130, 246, 0.1);
    }

    .button-hover-effect:active {
      transform: translateY(0);
    }

    .toggle-button.active {
      background-color: rgb(59, 130, 246);
      color: white;
    }

    .toggle-button.active:hover {
      background-color: rgb(37, 99, 235);
    }

    .typing-cursor {
      animation: blink 1s infinite;
      font-weight: bold;
      color: #3B82F6;
    }

    @keyframes blink {

      0%,
      50% {
        opacity: 1;
      }

      51%,
      100% {
        opacity: 0;
      }
    }

    /* è¾“å…¥æ¡†å“åº”çŠ¶æ€åŠ¨ç”» */
    @keyframes pulse-border {

      0%,
      100% {
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        border-color: #3B82F6;
      }

      50% {
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
        border-color: #1D4ED8;
      }
    }

    /* ä¸­æ–­æç¤ºåŠ¨ç”» */
    @keyframes bounce-in {
      0% {
        opacity: 0;
        transform: translateY(10px) scale(0.8);
      }

      50% {
        transform: translateY(-5px) scale(1.05);
      }

      100% {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes fade-out {
      0% {
        opacity: 1;
        transform: scale(1);
      }

      100% {
        opacity: 0;
        transform: scale(0.9);
      }
    }

    /* ä¸­æ–­æŒ‰é’®è„‰å†²æ•ˆæœ */
    @keyframes interrupt-pulse {

      0%,
      100% {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        transform: scale(1.05);
      }

      50% {
        box-shadow: 0 0 0 6px rgba(239, 68, 68, 0.2);
        transform: scale(1.08);
      }
    }

    /* åˆ é™¤æŒ‰é’®æ ·å¼ */
    .delete-chat-btn {
      transition: all 0.2s ease;
    }

    .delete-chat-btn:hover {
      transform: scale(1.1);
    }

    .delete-chat-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* æ–°å¯¹è¯æŒ‰é’®ç¦ç”¨çŠ¶æ€ */
    .new-chat-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    /* å†å²è®°å½•é¡¹hoveræ•ˆæœ */
    .history-item .group:hover {
      background-color: rgba(239, 246, 255, 0.5);
    }

    /* æ¨¡æ€æ¡†åŠ¨ç”» */
    .modal-enter {
      animation: modalEnter 0.3s ease-out;
    }

    @keyframes modalEnter {
      from {
        opacity: 0;
        transform: scale(0.9);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* æç¤ºæ¡†æ ·å¼ */
    .toast {
      backdrop-filter: blur(8px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    /* å†å²è®°å½•é¡¹é€‰ä¸­çŠ¶æ€ */
    .history-item.active-chat {
      background: linear-gradient(135deg, #EEF3FE 0%, #E0EFFF 100%);
      border-left: 3px solid #4E89FD;
    }

    /* Markdown æ ·å¼ */
    .markdown-content h1 {
      font-size: 1.875rem;
      font-weight: 700;
      margin: 1.5rem 0 1rem 0;
      line-height: 1.2;
      color: #1f2937;
    }

    .markdown-content h2 {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 1.25rem 0 0.75rem 0;
      line-height: 1.3;
      color: #374151;
    }

    .markdown-content h3 {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 1rem 0 0.5rem 0;
      line-height: 1.4;
      color: #4b5563;
    }

    .markdown-content p {
      margin: 0.75rem 0;
      line-height: 1.6;
      color: #374151;
    }

    .markdown-content strong {
      font-weight: 600;
      color: #1f2937;
    }

    .markdown-content em {
      font-style: italic;
      color: #4b5563;
    }

    .markdown-content code {
      background-color: #f3f4f6;
      padding: 0.125rem 0.25rem;
      border-radius: 0.25rem;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 0.875rem;
      color: #dc2626;
    }

    .markdown-content pre {
      background-color: #1f2937;
      color: #f9fafb;
      padding: 1rem;
      border-radius: 0.5rem;
      overflow-x: auto;
      margin: 1rem 0;
    }

    .markdown-content pre code {
      background-color: transparent;
      padding: 0;
      color: inherit;
      font-size: 0.875rem;
    }

    .markdown-content ul,
    .markdown-content ol {
      margin: 0.75rem 0;
      padding-left: 1.5rem;
    }

    .markdown-content li {
      margin: 0.25rem 0;
      line-height: 1.5;
    }

    .markdown-content blockquote {
      border-left: 4px solid #3b82f6;
      background-color: #eff6ff;
      padding: 0.75rem 1rem;
      margin: 1rem 0;
      font-style: italic;
      color: #1e40af;
    }

    .markdown-content a {
      color: #3b82f6;
      text-decoration: underline;
    }

    .markdown-content a:hover {
      color: #1d4ed8;
    }

    .markdown-content table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }

    .markdown-content th,
    .markdown-content td {
      border: 1px solid #d1d5db;
      padding: 0.5rem;
      text-align: left;
    }

    .markdown-content th {
      background-color: #f9fafb;
      font-weight: 600;
    }

    .markdown-content hr {
      border: none;
      border-top: 1px solid #e5e7eb;
      margin: 1.5rem 0;
    }

    /* æ•°å­¦å…¬å¼æ ·å¼ */
    .katex {
      font-size: 1em;
    }

    .katex-display {
      margin: 1rem 0;
      text-align: center;
    }

    .markdown-content .katex-display {
      background-color: #f8fafc;
      padding: 1rem;
      border-radius: 0.5rem;
      border: 1px solid #e2e8f0;
      overflow-x: auto;
    }

    .markdown-content .katex-html {
      overflow-x: auto;
      overflow-y: hidden;
    }

    /* æ•°å­¦å…¬å¼å®¹å™¨çš„ç¨³å®šæ€§ï¼Œé˜²æ­¢è·³åŠ¨ */
    .katex-display,
    .katex {
      min-height: 1.2em;
      transition: none;
    }

    /* ä¼˜åŒ–æ•°å­¦å…¬å¼æ˜¾ç¤º */
    .markdown-content {
      transition: none;
    }

    /* æ•°å­¦å…¬å¼æ¸²æŸ“ä¼˜åŒ– - å½»åº•é˜²é—ªåŠ¨æ–¹æ¡ˆ */
    .markdown-content {
      opacity: 1 !important;
      visibility: visible !important;
    }

    /* éšè—æœªæ¸²æŸ“çš„LaTeXä»£ç ï¼Œé˜²æ­¢é—ªåŠ¨ */
    .markdown-content:not([data-math-rendered="true"]) {
      font-family: 'Times New Roman', serif;
    }

    .markdown-content:not([data-math-rendered="true"]) code {
      opacity: 0.3;
      transition: opacity 0.1s ease;
    }

    /* LaTeXè¯­æ³•é«˜äº®ï¼Œè®©æœªæ¸²æŸ“çš„ä»£ç çœ‹èµ·æ¥æ›´æ¥è¿‘æœ€ç»ˆæ•ˆæœ */
    .markdown-content:not([data-math-rendered="true"]) code:contains("$") {
      font-family: 'Times New Roman', serif;
      color: #1a1a1a;
      background: none;
      font-size: 1.1em;
    }

    /* ç¡®ä¿æ•°å­¦å…¬å¼å ä½ç¬¦ä¸ä¼šé€ æˆå¸ƒå±€è·³åŠ¨ */
    .katex,
    .katex-display {
      display: inline-block;
      vertical-align: baseline;
    }

    /* LaTeXä»£ç æ ·å¼ - ä¸æ¸²æŸ“åçš„å…¬å¼ä¿æŒè§†è§‰ä¸€è‡´æ€§ */
    code:has-text($),
    code:has-text($$) {
      font-family: 'KaTeX_Main', 'Times New Roman', serif;
      font-size: 1.05em;
      background-color: transparent;
      color: #333;
      padding: 0;
    }

    /* å¤©æ°”å¡ç‰‡ä¼˜åŒ–æ ·å¼ */
    .weather-card {
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      position: relative;
      overflow: hidden;
    }

    .weather-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.1);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .weather-card:hover::before {
      opacity: 1;
    }

    .weather-icon-animation {
      animation: float 3s ease-in-out infinite;
      transition: transform 0.3s ease;
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0px) rotate(0deg);
      }

      33% {
        transform: translateY(-5px) rotate(1deg);
      }

      66% {
        transform: translateY(5px) rotate(-1deg);
      }
    }

    /* å¤©æ°”å¡ç‰‡æ‚¬æµ®æ•ˆæœ */
    .weather-card:hover .weather-icon-animation {
      animation-duration: 1.5s;
      transform: scale(1.1);
    }

    /* åŠ è½½åŠ¨ç”»ä¼˜åŒ– */
    .loading-animation {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    /* æ¶ˆæ¯å…¥åœºåŠ¨ç”» */
    .message-enter {
      animation: slideInUp 0.3s ease-out;
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* å…‰æ ‡é—ªçƒä¼˜åŒ– */
    .typing-cursor {
      animation: blink 1s infinite;
      font-weight: bold;
    }

    @keyframes blink {

      0%,
      50% {
        opacity: 1;
      }

      51%,
      100% {
        opacity: 0;
      }
    }

    /* æ»šåŠ¨æ¡ç¾åŒ– */
    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: #f8fafc;
      border-radius: 3px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }

    .chat-messages::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    /* æŒ‰é’®æ‚¬æµ®æ•ˆæœä¼˜åŒ– */
    #send-button,
    #voice-button {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    #send-button:hover,
    #voice-button:hover {
      transform: scale(1.1);
    }

    /* æ–‡æœ¬é€‰æ‹©æ ·å¼ */
    ::selection {
      background-color: #3B82F6;
      color: white;
    }

    /* å¤©æ°”è¯¦æƒ…é¡¹çš„æ‚¬æµ®æ•ˆæœ */
    .weather-card .group:hover {
      transform: translateX(2px);
    }

    /* å“åº”å¼ä¼˜åŒ– */
    @media (max-width: 768px) {
      .weather-card {
        margin-left: -1rem;
        margin-right: -1rem;
        border-radius: 0.75rem;
      }

      .weather-card .grid {
        grid-template-columns: 1fr;
        gap: 0.5rem;
      }

      .weather-card .text-5xl {
        font-size: 3rem;
      }

      /* ç§»åŠ¨ç«¯å¸ƒå±€ä¼˜åŒ– - ä½¿ç”¨ç»Ÿä¸€çš„ .sidebar ç±» */

      .mobile-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease-in-out;
      }

      .mobile-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      /* ç§»åŠ¨ç«¯å¤´éƒ¨ä¼˜åŒ– */
      .mobile-header {
        display: none;
        /* é»˜è®¤éšè— */
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
      }

      /* ç§»åŠ¨ç«¯æ˜¾ç¤ºå¤´éƒ¨ */
      @media (max-width: 768px) {
        .mobile-header {
          display: flex !important;
        }
      }

      /* ç§»åŠ¨ç«¯è¾“å…¥åŒºåŸŸä¼˜åŒ– */
      .mobile-input-area {
        padding: 0.75rem;
      }

      .mobile-input-area .toggle-button {
        font-size: 0.75rem;
        padding: 0.5rem 0.75rem;
      }

      /* ç§»åŠ¨ç«¯èŠå¤©åŒºåŸŸä¼˜åŒ– */
      .mobile-chat-area {
        padding: 1rem 0.75rem;
      }

      /* ç§»åŠ¨ç«¯å­—ä½“å¤§å°è°ƒæ•´ */
      .mobile-text-sm {
        font-size: 0.875rem;
      }

      /* ç§»åŠ¨ç«¯æŒ‰é’®ä¼˜åŒ– */
      .mobile-btn {
        min-height: 44px;
        font-size: 0.875rem;
      }

      /* ç§»åŠ¨ç«¯ä¾§è¾¹æ æ˜¾ç¤ºä¸ºå…¨å±æ»‘å‡º */
      .sidebar {
        position: fixed;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100vh;
        z-index: 1000;
        transition: left 0.3s ease-in-out;
      }

      .sidebar.show {
        left: 0;
      }

      /* æ˜¾ç¤ºç§»åŠ¨ç«¯èœå•æŒ‰é’® */
      .mobile-menu-btn {
        display: flex !important;
      }

      /* ç§»åŠ¨ç«¯æ¬¢è¿åŒºåŸŸä¼˜åŒ– */
      .mobile-welcome {
        padding: 2rem 1rem;
        text-align: center;
      }

      .mobile-welcome h2 {
        font-size: 1.25rem;
      }

      .mobile-welcome p {
        font-size: 0.875rem;
      }
    }

    /* æ¡Œé¢ç«¯éšè—ç§»åŠ¨ç«¯ä¸“ç”¨å…ƒç´ å¹¶é‡ç½®ä¾§è¾¹æ  */
    @media (min-width: 769px) {
      .mobile-menu-btn {
        display: none !important;
      }

      .mobile-overlay {
        display: none !important;
      }

      .mobile-header {
        display: none !important;
      }

      /* æ¡Œé¢ç«¯ä¾§è¾¹æ æ­£å¸¸æ˜¾ç¤º */
      .sidebar {
        position: static !important;
        left: auto !important;
        width: 16rem !important;
        /* w-64 */
        height: auto !important;
        z-index: auto !important;
        transition: none !important;
      }
    }
  </style>
</head>

<body
  class="bg-[conic-gradient(at_top,_var(--tw-gradient-stops))] from-white via-sky-50 to-blue-50/30 font-sans text-gray-900">
  <!-- ç§»åŠ¨ç«¯é®ç½©å±‚ -->
  <div id="mobile-overlay" class="mobile-overlay"></div>

  <div class="flex h-full w-full">
    <!-- å·¦ä¾§è¾¹æ  -->
    <div id="sidebar"
      class="sidebar w-64 bg-white/90 backdrop-blur-2xl border-r border-white/50 flex flex-col shadow-[0_0_50px_rgba(0,0,0,0.05)]">
      <!-- å“ç‰Œæ ‡è¯† -->
      <div class="p-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <!-- Logoå›¾æ ‡ -->
          <div class="relative">
            <div
              class="w-10 h-10 bg-gradient-to-br from-blue-500 via-purple-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-200/50 transform rotate-3 hover:rotate-0 transition-transform duration-300 overflow-hidden">
              <img src="image/AI å°å­.png" alt="AIå°å­Logo" class="w-8 h-8 object-contain">
            </div>
            <div
              class="absolute -top-1 -right-1 w-3 h-3 bg-gradient-to-r from-green-400 to-blue-500 rounded-full animate-pulse">
            </div>
          </div>
          <!-- Logoæ–‡å­— -->
          <div class="flex flex-col">
            <div
              class="font-bold text-xl bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 bg-clip-text text-transparent">
              AIå°å­
            </div>
            <div class="text-xs text-gray-400 font-medium tracking-wide">
              æ™ºèƒ½åŠ©æ‰‹
            </div>
          </div>
        </div>
        <button id="close-sidebar-btn"
          class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-gray-700 transition-colors cursor-pointer md:hidden">
          <i class="ri-close-line ri-lg"></i>
        </button>
        <div
          class="w-8 h-8 flex items-center justify-center text-gray-500 hover:text-gray-700 transition-colors cursor-pointer hidden md:flex">
          <i class="ri-menu-line ri-lg"></i>
        </div>
      </div>
      <!-- æ–°å¯¹è¯æŒ‰é’® -->
      <div class="p-3">
        <button id="sidebar-new-chat-btn"
          class="new-chat-btn bg-blue-50 text-blue-600 py-1.5 px-4 flex items-center justify-center gap-1.5 rounded-full hover:bg-blue-100 transition-colors text-sm mx-auto whitespace-nowrap">
          <i class="ri-add-line text-xs"></i>
          <span>å¼€å¯æ–°å¯¹è¯</span>
        </button>
      </div>
      <!-- å¯¹è¯å†å² -->
      <div class="flex-1 overflow-y-auto">
        <div id="history-container">
          <!-- å†å²å¯¹è¯å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
          <div class="p-3 text-center text-gray-400 text-sm">
            <i class="ri-loader-4-line animate-spin mr-1"></i>
            æ­£åœ¨åŠ è½½å†å²å¯¹è¯...
          </div>
        </div>
      </div>
      <!-- åº•éƒ¨åŠŸèƒ½åŒº -->
      <div class="p-3 border-t border-gray-100 space-y-2">
        <!-- ç”¨æˆ·ä¿¡æ¯ -->
        <div class="flex items-center justify-between bg-gray-50 rounded-lg p-2">
          <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
              <i class="ri-user-3-line text-white text-sm"></i>
            </div>
            <div class="min-w-0 flex-1">
              <div id="user-display" class="text-sm font-medium text-gray-700 truncate">
                åŠ è½½ä¸­...
              </div>
              <div class="text-xs text-gray-500">å·²ç™»å½•</div>
            </div>
          </div>
          <button onclick="logout()"
            class="w-6 h-6 flex items-center justify-center text-gray-400 hover:text-red-500 transition-colors"
            title="ç™»å‡º">
            <i class="ri-logout-box-line text-sm"></i>
          </button>
        </div>
      </div>
    </div>
    <!-- ä¸­é—´èŠå¤©åŒºåŸŸ -->
    <div class="flex-1 flex flex-col bg-white">
      <!-- ç§»åŠ¨ç«¯å¤´éƒ¨ -->
      <div class="mobile-header">
        <button id="mobile-menu-btn"
          class="mobile-menu-btn w-10 h-10 flex items-center justify-center text-gray-600 hover:text-gray-800 rounded-lg hover:bg-gray-100 transition-colors">
          <i class="ri-menu-line ri-lg"></i>
        </button>
        <div class="flex items-center gap-2">
          <div
            class="w-8 h-8 bg-gradient-to-br from-blue-500 via-purple-500 to-indigo-600 rounded-lg flex items-center justify-center">
            <img src="image/AI å°å­.png" alt="AIå°å­Logo" class="w-6 h-6 object-contain">
          </div>
          <div
            class="font-bold text-lg bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 bg-clip-text text-transparent">
            AIå°å­
          </div>
        </div>
        <div class="w-10 h-10"></div> <!-- å ä½ç¬¦ï¼Œä¿æŒå±…ä¸­ -->
      </div>

      <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
      <div class="flex-1 overflow-y-auto chat-messages p-4 md:p-4 mobile-chat-area">
        <!-- åˆå§‹æ¬¢è¿ä¿¡æ¯ -->
        <div id="welcome-message" class="flex flex-col items-center justify-center h-full mobile-welcome">
          <div class="relative mb-6">
            <div
              class="w-20 h-20 md:w-16 md:h-16 bg-gradient-to-br from-blue-500 via-purple-500 to-indigo-600 rounded-2xl flex items-center justify-center shadow-2xl shadow-blue-200/50 ring-8 ring-white/80 backdrop-blur-xl transform rotate-3 hover:rotate-0 transition-transform duration-500 overflow-hidden">
              <img src="image/AI å°å­.png" alt="AIå°å­Logo" class="w-16 h-16 md:w-12 md:h-12 object-contain">
            </div>
            <div
              class="absolute -top-2 -right-2 w-6 h-6 md:w-4 md:h-4 bg-gradient-to-r from-green-400 to-blue-500 rounded-full animate-pulse flex items-center justify-center">
              <div class="w-2 h-2 md:w-1 md:h-1 bg-white rounded-full"></div>
            </div>
          </div>
          <h2 class="text-xl md:text-lg font-medium mb-2 mobile-text-sm">ä½ å¥½ï¼Œ<span
              id="user-name-display">2518016656</span>ï¼</h2>
          <h2 class="text-xl md:text-lg font-medium mb-2 mobile-text-sm">æˆ‘æ˜¯ <span
              class="bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 bg-clip-text text-transparent font-bold">AIå°å­</span>ï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼
          </h2>
          <p class="text-gray-500 text-center max-w-md mb-4 mobile-text-sm px-4">æˆ‘å¯ä»¥å¸®ä½ å†™ä»£ç ã€å›ç­”é—®é¢˜ã€ç”Ÿæˆå†…å®¹ã€‚è¯·æŠŠä½ çš„ä»»åŠ¡äº¤ç»™æˆ‘å§ï½</p>
        </div>
        <!-- èŠå¤©æ¶ˆæ¯å®¹å™¨ (åŠ¨æ€ç”Ÿæˆå†…å®¹) -->
        <div id="chat-content" class="hidden space-y-6">
          <!-- çœŸå®çš„èŠå¤©æ¶ˆæ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
        </div>
      </div>
      <!-- æ–°å¯¹è¯æŒ‰é’® (åˆå§‹éšè—) -->
      <div id="new-chat-button" class="hidden px-4 py-2">
        <button id="chat-new-chat-btn"
          class="new-chat-btn bg-[#EEF3FE] text-[#4E89FD] py-1.5 px-4 flex items-center justify-center gap-1.5 rounded-full hover:bg-blue-100 transition-colors text-sm mx-auto whitespace-nowrap">
          <i class="ri-add-line text-xs"></i>
          <span>å¼€å¯æ–°å¯¹è¯</span>
        </button>
      </div>
      <!-- è¾“å…¥åŒºåŸŸ -->
      <div class="p-4 md:p-3 mobile-input-area">
        <div class="flex items-center gap-2 mb-3">

          <button id="search-toggle"
            class="toggle-button bg-gray-50 text-gray-600 py-1.5 px-3 rounded-lg text-sm flex items-center gap-1 whitespace-nowrap hover:bg-gray-100 transition-colors mobile-btn">
            <div class="w-4 h-4 flex items-center justify-center">
              <i class="ri-search-line"></i>
            </div>
            <span>è”ç½‘æœç´¢</span>
          </button>
        </div>

        <!-- ä¸Šä¼ æ–‡ä»¶å¡ç‰‡æ˜¾ç¤ºåŒºåŸŸ -->
        <div id="uploaded-files-display" class="space-y-2 mb-4 hidden">
        </div>

        <div class="relative">
          <textarea
            class="message-input w-full bg-gray-50 rounded-lg pl-4 pr-12 py-3 resize-none border-none h-12 text-gray-800 focus:bg-gray-100 transition-colors"
            placeholder="ç»™ AIå°å­ å‘é€æ¶ˆæ¯" rows="1"></textarea>
          <div class="absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-2">
            <button
              class="w-8 h-8 md:w-10 md:h-10 flex items-center justify-center text-gray-500 hover:text-gray-700 mobile-btn"
              title="ä¸Šä¼ æ–‡ä»¶">
              <i class="ri-attachment-2"></i>
            </button>
            <button id="voice-button"
              class="w-8 h-8 md:w-10 md:h-10 flex items-center justify-center text-gray-500 hover:text-primary transition-colors mobile-btn"
              title="ç‚¹å‡»å½•éŸ³">
              <i class="ri-mic-line"></i>
            </button>
            <button id="send-button"
              class="w-8 h-8 md:w-10 md:h-10 flex items-center justify-center text-gray-400 hover:text-primary mobile-btn">
              <i class="ri-send-plane-fill"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script id="chat-interaction">
    // ç®€åŒ–çš„Markdownæ¸²æŸ“å‡½æ•° - ç›´æ¥å¤„ç†ï¼Œè®©KaTeXåç»­æ¸²æŸ“æ•°å­¦å…¬å¼
    function renderMarkdown(text) {
      if (typeof marked === 'undefined') {
        return text.replace(/\n/g, '<br>');
      }

      try {
        // é…ç½®markedé€‰é¡¹
        marked.setOptions({
          breaks: true,
          gfm: true,
          sanitize: false
        });

        // ç›´æ¥æ¸²æŸ“Markdownï¼Œä¸è¿›è¡Œå¤æ‚çš„å ä½ç¬¦å¤„ç†
        // è®©KaTeXåœ¨åç»­æ­¥éª¤ä¸­ç›´æ¥å¤„ç†æ•°å­¦å…¬å¼
        let rendered = marked.parse(text);

        // ä½¿ç”¨DOMPurifyæ¸…ç†HTMLä»¥é˜²æ­¢XSSæ”»å‡»
        rendered = typeof DOMPurify !== 'undefined' ? DOMPurify.sanitize(rendered, {
          ADD_TAGS: ['math', 'semantics', 'mrow', 'mi', 'mo', 'mn', 'msup', 'msub', 'mfrac', 'msqrt'],
          ADD_ATTR: ['class', 'style']
        }) : rendered;

        // æ¸…ç†ä»»ä½•å¯èƒ½çš„å ä½ç¬¦æ®‹ç•™
        rendered = cleanupMathPlaceholders(rendered);

        return rendered;
      } catch (error) {
        console.error('Markdownæ¸²æŸ“é”™è¯¯:', error);
        return text.replace(/\n/g, '<br>');
      }
    }

    // æ¸…ç†æ•°å­¦å…¬å¼å ä½ç¬¦çš„è¾…åŠ©å‡½æ•°
    function cleanupMathPlaceholders(text) {
      // ç§»é™¤æ‰€æœ‰å½¢å¦‚ MATH_BLOCK_N æˆ– MATH_INLINE_N çš„å ä½ç¬¦
      text = text.replace(/MATH_(BLOCK|INLINE)_\d+/g, '[æ•°å­¦å…¬å¼]');
      // ç§»é™¤æ‰€æœ‰å½¢å¦‚ __MATH_BLOCK_N__ æˆ– __MATH_INLINE_N__ çš„å ä½ç¬¦
      text = text.replace(/__MATH_(BLOCK|INLINE)_\d+__/g, '[æ•°å­¦å…¬å¼]');
      return text;
    }

    // è¿™äº›å‡½æ•°å·²ç»ä¸å†éœ€è¦ï¼Œå› ä¸ºæˆ‘ä»¬ç®€åŒ–äº†æ¸²æŸ“é€»è¾‘

    // è½¬ä¹‰æ­£åˆ™è¡¨è¾¾å¼ç‰¹æ®Šå­—ç¬¦
    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // æ•°å­¦å…¬å¼æ¸²æŸ“é…ç½®
    const mathConfig = {
      delimiters: [
        { left: '$$', right: '$$', display: true },
        { left: '$', right: '$', display: false },
        { left: '\\(', right: '\\)', display: false },
        { left: '\\[', right: '\\]', display: true }
      ],
      throwOnError: false,
      errorColor: '#cc0000',
      strict: false
    };

    // ç­‰å¾…KaTeXåŠ è½½å®Œæˆçš„å‡½æ•° - ä¼˜åŒ–ç‰ˆæœ¬
    function waitForKaTeX() {
      return new Promise((resolve, reject) => {
        if (typeof window.renderMathInElement === 'function') {
          resolve();
          return;
        }

        let attempts = 0;
        const maxAttempts = 30; // 3ç§’è¶…æ—¶ï¼Œå‡å°‘ç­‰å¾…æ—¶é—´
        const checkKaTeX = setInterval(() => {
          attempts++;

          if (typeof window.renderMathInElement === 'function') {
            clearInterval(checkKaTeX);
            resolve();
          } else if (attempts >= maxAttempts) {
            clearInterval(checkKaTeX);
            reject(new Error('KaTeXåŠ è½½è¶…æ—¶'));
          }
        }, 100);
      });
    }

    // å®‰å…¨æ¸²æŸ“æ•°å­¦å…¬å¼ - å¿«é€Ÿæ— é—ªåŠ¨ç‰ˆæœ¬
    async function renderMathSafely(element) {
      if (!element || typeof window.renderMathInElement !== 'function') {
        return Promise.resolve();
      }

      // å¦‚æœæ­£åœ¨æ¸²æŸ“ï¼Œç­‰å¾…å®Œæˆ
      if (element.dataset.mathRendering === 'true') {
        return new Promise(resolve => {
          const checkInterval = setInterval(() => {
            if (element.dataset.mathRendering !== 'true') {
              clearInterval(checkInterval);
              resolve();
            }
          }, 10);
        });
      }

      try {
        // æ ‡è®°æ­£åœ¨æ¸²æŸ“
        element.dataset.mathRendering = 'true';

        // åŒæ­¥æ¸²æŸ“æ•°å­¦å…¬å¼
        window.renderMathInElement(element, mathConfig);

        // æ ‡è®°æ¸²æŸ“å®Œæˆ
        element.dataset.mathRendered = 'true';
        delete element.dataset.mathRendering;

        return Promise.resolve();
      } catch (error) {
        console.error('æ•°å­¦å…¬å¼æ¸²æŸ“é”™è¯¯:', error);
        delete element.dataset.mathRendering;
        return Promise.resolve();
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      // è®¤è¯ç›¸å…³å˜é‡
      let currentUser = null;
      let authToken = null;

      // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
      function checkAuthStatus() {
        const token = localStorage.getItem('ai_token');
        const user = localStorage.getItem('ai_user');

        if (!token || !user) {
          // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
          window.location.href = '/login.html';
          return false;
        }

        try {
          authToken = token;
          currentUser = JSON.parse(user);
          console.log('ç”¨æˆ·å·²ç™»å½•:', currentUser.email);

          // æ›´æ–°ç”¨æˆ·ç•Œé¢æ˜¾ç¤º
          updateUserUI();
          return true;
        } catch (error) {
          console.error('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
          // æ¸…é™¤æ— æ•ˆæ•°æ®å¹¶è·³è½¬åˆ°ç™»å½•é¡µ
          localStorage.removeItem('ai_token');
          localStorage.removeItem('ai_user');
          window.location.href = '/login.html';
          return false;
        }
      }

      // æ›´æ–°ç”¨æˆ·ç•Œé¢
      function updateUserUI() {
        if (!currentUser) return;

        // æ˜¾ç¤ºç”¨æˆ·é‚®ç®±ï¼ˆå¯ä»¥æ·»åŠ åˆ°é¡µé¢å¤´éƒ¨ï¼‰
        const userDisplay = document.getElementById('user-display');
        if (userDisplay) {
          userDisplay.textContent = currentUser.email;
        }

        // æ›´æ–°æ¬¢è¿æ¶ˆæ¯
        const welcomeMsg = document.querySelector('#welcome-message h2');
        if (welcomeMsg) {
          welcomeMsg.textContent = `ä½ å¥½ï¼Œ${currentUser.email.split('@')[0]}ï¼`;
        }
      }

      // APIè¯·æ±‚è¾…åŠ©å‡½æ•°
      function getAuthHeaders() {
        return {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${authToken}`
        };
      }

      // å¤„ç†è®¤è¯é”™è¯¯
      function handleAuthError(error) {
        console.error('è®¤è¯é”™è¯¯:', error);

        // å¦‚æœæ˜¯tokenæ— æ•ˆï¼Œæ¸…é™¤ç™»å½•çŠ¶æ€å¹¶è·³è½¬
        if (error.code === 'TOKEN_INVALID' || error.code === 'TOKEN_MISSING') {
          localStorage.removeItem('ai_token');
          localStorage.removeItem('ai_user');
          alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
          window.location.href = '/login.html';
        }
      }

      // ç™»å‡ºåŠŸèƒ½
      window.logout = async function () {
        try {
          // è°ƒç”¨ç™»å‡ºAPI
          await fetch('/api/auth/logout', {
            method: 'POST',
            headers: getAuthHeaders()
          });
        } catch (error) {
          console.error('ç™»å‡ºAPIè°ƒç”¨å¤±è´¥:', error);
        } finally {
          // æ¸…é™¤æœ¬åœ°å­˜å‚¨
          localStorage.removeItem('ai_token');
          localStorage.removeItem('ai_user');
          // è·³è½¬åˆ°ç™»å½•é¡µé¢
          window.location.href = '/login.html';
        }
      };

      // åˆå§‹åŒ–è®¤è¯æ£€æŸ¥
      if (!checkAuthStatus()) {
        return; // å¦‚æœæœªè®¤è¯ï¼Œä¸ç»§ç»­æ‰§è¡Œåç»­ä»£ç 
      }

      const messageInput = document.querySelector('.message-input');
      const sendButton = document.getElementById('send-button');
      const voiceButton = document.getElementById('voice-button');
      const welcomeMessage = document.getElementById('welcome-message');
      const chatContent = document.getElementById('chat-content');
      const newChatButton = document.getElementById('new-chat-button');
      const searchToggle = document.getElementById('search-toggle');

      // é¡µé¢åŠ è½½æ—¶é‡ç½®çŠ¶æ€
      window.isAIResponding = false;
      disableUserInput(false);

      // å»¶è¿Ÿæ£€æŸ¥æ•°å­¦å…¬å¼åº“æ˜¯å¦åŠ è½½å®Œæˆ
      setTimeout(() => {
        if (typeof window.renderMathInElement !== 'function') {
          console.warn('æ•°å­¦å…¬å¼æ¸²æŸ“åº“æœªèƒ½æ­£å¸¸åŠ è½½');
        }
      }, 2000);

      // é¡µé¢å¸è½½å‰æ¸…ç†çŠ¶æ€
      window.addEventListener('beforeunload', function () {
        window.isAIResponding = false;
      });

      // é¡µé¢å¤±å»ç„¦ç‚¹æ—¶çš„å¤„ç†ï¼ˆæ¯”å¦‚ç”¨æˆ·åˆ‡æ¢åˆ°å…¶ä»–æ ‡ç­¾é¡µï¼‰
      window.addEventListener('visibilitychange', function () {
        if (!document.hidden && window.isAIResponding) {
          // é¡µé¢é‡æ–°è·å¾—ç„¦ç‚¹æ—¶ï¼Œå¦‚æœçŠ¶æ€è¿˜æ˜¯å“åº”ä¸­ï¼Œç»™äºˆæç¤º
          console.log('é¡µé¢é‡æ–°è·å¾—ç„¦ç‚¹ï¼Œæ£€æŸ¥AIå“åº”çŠ¶æ€');
        }
      });

      // è°ƒè¯•åŠŸèƒ½ï¼šæ‰‹åŠ¨é‡ç½®çŠ¶æ€ï¼ˆåœ¨æ§åˆ¶å°ä¸­è°ƒç”¨ resetAIState()ï¼‰
      window.resetAIState = function () {
        console.log('æ‰‹åŠ¨é‡ç½®AIå“åº”çŠ¶æ€');
        interruptAIResponse();
        showToast('AIçŠ¶æ€å·²é‡ç½®', 'success');
      };

      // è°ƒè¯•åŠŸèƒ½ï¼šæ‰‹åŠ¨æ¸²æŸ“æ•°å­¦å…¬å¼ï¼ˆåœ¨æ§åˆ¶å°ä¸­è°ƒç”¨ debugRenderMath()ï¼‰
      window.debugRenderMath = function () {
        console.log('å¼€å§‹è°ƒè¯•æ•°å­¦å…¬å¼æ¸²æŸ“...');
        console.log('KaTeXçŠ¶æ€:', typeof window.katex);
        console.log('renderMathInElementçŠ¶æ€:', typeof window.renderMathInElement);

        // æŸ¥æ‰¾æ‰€æœ‰AIæ¶ˆæ¯å¹¶å°è¯•æ¸²æŸ“
        const aiMessages = document.querySelectorAll('.ai-content');
        console.log('æ‰¾åˆ°AIæ¶ˆæ¯æ•°é‡:', aiMessages.length);

        aiMessages.forEach((element, index) => {
          console.log(`æ¸²æŸ“æ¶ˆæ¯ ${index + 1}:`, element.innerHTML);
          renderMathSafely(element);
        });

        return 'æ•°å­¦å…¬å¼è°ƒè¯•å®Œæˆï¼ŒæŸ¥çœ‹æ§åˆ¶å°è¾“å‡º';
      };
      // æŒ‰é’®åˆ‡æ¢åŠŸèƒ½
      searchToggle.addEventListener('click', function () {
        this.classList.toggle('active');
      });

      // è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬åŒºåŸŸé«˜åº¦
      messageInput.addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight > 48) ? this.scrollHeight + 'px' : '48px';
      });
      // å‘é€æ¶ˆæ¯
      sendButton.addEventListener('click', async function () {
        // å¦‚æœAIæ­£åœ¨å“åº”ï¼Œè¿™ä¸ªæŒ‰é’®ç°åœ¨æ˜¯ä¸­æ–­æŒ‰é’®
        if (window.isAIResponding) {
          console.log('ç”¨æˆ·ç‚¹å‡»ä¸­æ–­æŒ‰é’®ï¼Œåœæ­¢AIå“åº”');
          interruptAIResponse();
          showToast('å·²åœæ­¢AIå›å¤ï¼Œç°åœ¨å¯ä»¥å‘é€æ–°æ¶ˆæ¯', 'success');
          return; // åªä¸­æ–­ï¼Œä¸å‘é€æ¶ˆæ¯
        }

        // æ­£å¸¸å‘é€æ¶ˆæ¯æµç¨‹
        const message = messageInput.value.trim();
        if (!message) return;

        console.log('å‘é€æ¶ˆæ¯:', message);
        // ç«‹å³æ¸…ç©ºè¾“å…¥æ¡†å¹¶é‡ç½®é«˜åº¦
        messageInput.value = '';
        messageInput.style.height = '48px';

        // éšè—æ¬¢è¿ä¿¡æ¯ï¼Œæ˜¾ç¤ºèŠå¤©å†…å®¹å’Œæ–°å¯¹è¯æŒ‰é’®
        welcomeMessage.classList.add('hidden');
        chatContent.classList.remove('hidden');
        newChatButton.classList.remove('hidden');

        // å‘é€æ¶ˆæ¯åˆ°åç«¯
        await sendMessageToAPI(message);
      });

      // æŒ‰ Enter å‘é€æ¶ˆæ¯
      messageInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();

          // å¦‚æœAIæ­£åœ¨å“åº”ï¼Œæ˜¾ç¤ºä¸­æ–­æç¤º
          if (window.isAIResponding) {
            console.log('AIæ­£åœ¨å“åº”ä¸­ï¼Œæ˜¾ç¤ºåœæ­¢æŒ‰é’®æç¤º');
            showInterruptHint();
            return;
          }

          // æ­£å¸¸æƒ…å†µä¸‹è§¦å‘å‘é€æŒ‰é’®
          sendButton.click();
        }
      });

      // å½•éŸ³æŒ‰é’®äº‹ä»¶ç›‘å¬
      voiceButton.addEventListener('click', function () {
        if (isRecording) {
          stopRecording();
        } else {
          startRecording();
        }
      });

      // API äº¤äº’å‡½æ•°
      window.currentChatId = null;
      window.isAIResponding = false; // æ·»åŠ AIå“åº”çŠ¶æ€æ ‡è®°
      window.currentStreamController = null; // å½“å‰æµå¼å“åº”æ§åˆ¶å™¨

      // å½•éŸ³åŠŸèƒ½å˜é‡
      let mediaRecorder = null;
      let recordedChunks = [];
      let isRecording = false;
      let recordingStartTime = null;
      let recognition = null; // Web Speech API

      // å¹³æ»‘æ»šåŠ¨åˆ°åº•éƒ¨å‡½æ•°
      function smoothScrollToBottom() {
        const chatContainer = document.getElementById('chat-content');
        if (!chatContainer) return;

        // ä½¿ç”¨ scrollIntoView å®ç°å¹³æ»‘æ»šåŠ¨
        const lastMessage = chatContainer.lastElementChild;
        if (lastMessage) {
          lastMessage.scrollIntoView({
            behavior: 'smooth',
            block: 'end',
            inline: 'nearest'
          });
        } else {
          // å¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œç›´æ¥æ»šåŠ¨åˆ°åº•éƒ¨
          chatContainer.scrollTo({
            top: chatContainer.scrollHeight,
            behavior: 'smooth'
          });
        }
      }

      // å¼ºåˆ¶æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆæ— åŠ¨ç”»ï¼Œç”¨äºåˆå§‹åŒ–ç­‰åœºæ™¯ï¼‰
      function forceScrollToBottom() {
        const chatContainer = document.getElementById('chat-content');
        if (chatContainer) {
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }
      }

      // æ£€æŸ¥æ˜¯å¦éœ€è¦æ»šåŠ¨ï¼ˆç”¨äºä¼˜åŒ–æ€§èƒ½ï¼‰
      function shouldAutoScroll() {
        const chatContainer = document.getElementById('chat-content');
        if (!chatContainer) return false;

        // å¦‚æœç”¨æˆ·æ»šåŠ¨åˆ°æ¥è¿‘åº•éƒ¨ï¼ˆå®¹å·®50pxï¼‰ï¼Œåˆ™è®¤ä¸ºéœ€è¦è‡ªåŠ¨æ»šåŠ¨
        const isNearBottom = chatContainer.scrollTop + chatContainer.clientHeight >= chatContainer.scrollHeight - 50;
        return isNearBottom;
      }

      // æ™ºèƒ½æ»šåŠ¨ï¼šåªæœ‰å½“ç”¨æˆ·åœ¨åº•éƒ¨é™„è¿‘æ—¶æ‰è‡ªåŠ¨æ»šåŠ¨
      function smartScrollToBottom() {
        if (shouldAutoScroll()) {
          smoothScrollToBottom();
        } else {
          // å¦‚æœç”¨æˆ·ä¸åœ¨åº•éƒ¨ï¼Œæ˜¾ç¤º"å›åˆ°åº•éƒ¨"æŒ‰é’®
          showScrollToBottomButton();
        }
      }

      // æ˜¾ç¤ºå›åˆ°åº•éƒ¨æŒ‰é’®
      function showScrollToBottomButton() {
        let scrollButton = document.getElementById('scroll-to-bottom');

        if (!scrollButton) {
          scrollButton = document.createElement('button');
          scrollButton.id = 'scroll-to-bottom';
          scrollButton.className = 'fixed bottom-20 right-6 w-12 h-12 bg-blue-500 hover:bg-blue-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform translate-y-0 hover:-translate-y-1 z-50';
          scrollButton.innerHTML = '<i class="ri-arrow-down-line text-lg"></i>';
          scrollButton.title = 'å›åˆ°åº•éƒ¨';

          scrollButton.addEventListener('click', () => {
            smoothScrollToBottom();
            hideScrollToBottomButton();
          });

          document.body.appendChild(scrollButton);

          // å…¥åœºåŠ¨ç”»
          requestAnimationFrame(() => {
            scrollButton.style.opacity = '0';
            scrollButton.style.transform = 'translateY(20px)';
            scrollButton.style.transition = 'all 0.3s ease-out';

            requestAnimationFrame(() => {
              scrollButton.style.opacity = '1';
              scrollButton.style.transform = 'translateY(0)';
            });
          });
        }

        // è‡ªåŠ¨éšè—å®šæ—¶å™¨
        clearTimeout(scrollButton.hideTimer);
        scrollButton.hideTimer = setTimeout(hideScrollToBottomButton, 3000);
      }

      // éšè—å›åˆ°åº•éƒ¨æŒ‰é’®
      function hideScrollToBottomButton() {
        const scrollButton = document.getElementById('scroll-to-bottom');
        if (scrollButton) {
          scrollButton.style.opacity = '0';
          scrollButton.style.transform = 'translateY(20px)';
          setTimeout(() => {
            if (scrollButton.parentNode) {
              scrollButton.parentNode.removeChild(scrollButton);
            }
          }, 300);
        }
      }

      // ä¸­æ–­AIå“åº”å‡½æ•°
      function interruptAIResponse() {
        if (window.currentStreamController) {
          console.log('ä¸­æ–­å½“å‰AIæµå¼å“åº”');
          window.currentStreamController.abort();
          window.currentStreamController = null;
        }
        window.isAIResponding = false;
        disableUserInput(false);
      }

      // å½•éŸ³åŠŸèƒ½å‡½æ•° - ä½¿ç”¨Web Speech API
      function initializeSpeechRecognition() {
        try {
          // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
          if (!window.webkitSpeechRecognition && !window.SpeechRecognition) {
            console.warn('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«');
            return false;
          }

          // åˆ›å»ºè¯­éŸ³è¯†åˆ«å®ä¾‹
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          recognition = new SpeechRecognition();

          // é…ç½®è¯­éŸ³è¯†åˆ«
          recognition.continuous = false;  // ä¸è¿ç»­è¯†åˆ«
          recognition.interimResults = false;  // ä¸æ˜¾ç¤ºä¸­é—´ç»“æœ
          recognition.lang = 'zh-CN';  // é»˜è®¤ä¸­æ–‡ï¼Œä¹Ÿå¯ä»¥è‡ªåŠ¨è¯†åˆ«
          recognition.maxAlternatives = 1;  // æœ€å¤šè¿”å›1ä¸ªç»“æœ

          // ç›‘å¬è¯†åˆ«ç»“æœ
          recognition.onresult = function (event) {
            const result = event.results[0];
            if (result.isFinal) {
              const recognizedText = result[0].transcript;
              console.log('ğŸ¤ è¯­éŸ³è¯†åˆ«ç»“æœ:', recognizedText);
              handleSpeechResult(recognizedText);
            }
          };

          // ç›‘å¬è¯†åˆ«ç»“æŸ
          recognition.onend = function () {
            console.log('ğŸ¤ è¯­éŸ³è¯†åˆ«ç»“æŸ');
            isRecording = false;
            updateVoiceButtonState(false);
          };

          // ç›‘å¬è¯†åˆ«é”™è¯¯
          recognition.onerror = function (event) {
            console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
            isRecording = false;
            updateVoiceButtonState(false);

            let errorMessage = 'è¯­éŸ³è¯†åˆ«å¤±è´¥';
            switch (event.error) {
              case 'no-speech':
                errorMessage = 'æ²¡æœ‰æ£€æµ‹åˆ°è¯­éŸ³ï¼Œè¯·é‡è¯•';
                break;
              case 'audio-capture':
                errorMessage = 'æ— æ³•è®¿é—®éº¦å…‹é£';
                break;
              case 'not-allowed':
                errorMessage = 'éº¦å…‹é£æƒé™è¢«æ‹’ç»';
                break;
              case 'network':
                errorMessage = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥';
                break;
              default:
                errorMessage = `è¯­éŸ³è¯†åˆ«å¤±è´¥: ${event.error}`;
            }
            showToast(errorMessage, 'error');
          };

          // ç›‘å¬å¼€å§‹è¯†åˆ«
          recognition.onstart = function () {
            console.log('ğŸ¤ å¼€å§‹è¯­éŸ³è¯†åˆ«');
            isRecording = true;
            updateVoiceButtonState(true);
            showToast('è¯·è¯´è¯ï¼Œæ­£åœ¨å¬å–æ‚¨çš„è¯­éŸ³...', 'info');
          };

          return true;
        } catch (error) {
          console.error('åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«å¤±è´¥:', error);
          return false;
        }
      }

      function startRecording() {
        if (isRecording) {
          stopRecording();
          return;
        }

        if (!recognition) {
          const initialized = initializeSpeechRecognition();
          if (!initialized) {
            showToast('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½', 'error');
            return;
          }
        }

        try {
          console.log('ğŸ¤ å¯åŠ¨è¯­éŸ³è¯†åˆ«');
          recognition.start();
        } catch (error) {
          console.error('å¯åŠ¨è¯­éŸ³è¯†åˆ«å¤±è´¥:', error);
          showToast('è¯­éŸ³è¯†åˆ«å¯åŠ¨å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
      }

      function stopRecording() {
        if (recognition && isRecording) {
          console.log('ğŸ¤ åœæ­¢è¯­éŸ³è¯†åˆ«');
          recognition.stop();
        }
      }

      function updateVoiceButtonState(recording) {
        const icon = voiceButton.querySelector('i');

        if (recording) {
          icon.className = 'ri-stop-circle-fill';
          voiceButton.classList.add('text-red-500', 'animate-pulse');
          voiceButton.classList.remove('text-gray-500');
          voiceButton.title = 'ç‚¹å‡»åœæ­¢å½•éŸ³';
        } else {
          icon.className = 'ri-mic-line';
          voiceButton.classList.remove('text-red-500', 'animate-pulse');
          voiceButton.classList.add('text-gray-500');
          voiceButton.title = 'ç‚¹å‡»å½•éŸ³';
        }
      }

      async function handleSpeechResult(recognizedText) {
        try {
          console.log('ğŸ¤ å¤„ç†è¯†åˆ«ç»“æœ:', recognizedText);

          // æ£€æŸ¥æ˜¯å¦æ˜¯ä¸­æ–‡
          const isChinese = /[\u4e00-\u9fff]/.test(recognizedText);

          if (isChinese) {
            // å¦‚æœæ˜¯ä¸­æ–‡ï¼Œç›´æ¥ä½¿ç”¨
            showToast(`è¯†åˆ«æˆåŠŸ: ${recognizedText}`, 'success');
            messageInput.value = recognizedText;
          } else {
            // å¦‚æœä¸æ˜¯ä¸­æ–‡ï¼Œè°ƒç”¨ç¿»è¯‘API
            showToast('æ­£åœ¨ç¿»è¯‘ä¸ºä¸­æ–‡...', 'info');

            const response = await fetch('/api/voice/translate', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                text: recognizedText
              })
            });

            const result = await response.json();

            if (result.success) {
              const translatedText = result.data.translatedText;
              showToast(`è¯†åˆ«å¹¶ç¿»è¯‘æˆåŠŸ: ${recognizedText} â†’ ${translatedText}`, 'success');
              messageInput.value = translatedText;
            } else {
              showToast(`è¯†åˆ«æˆåŠŸï¼Œç¿»è¯‘å¤±è´¥: ${recognizedText}`, 'warning');
              messageInput.value = recognizedText;
            }
          }

          // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
          messageInput.style.height = 'auto';
          messageInput.style.height = (messageInput.scrollHeight > 48) ? messageInput.scrollHeight + 'px' : '48px';

          // èšç„¦åˆ°è¾“å…¥æ¡†
          messageInput.focus();

        } catch (error) {
          console.error('å¤„ç†è¯­éŸ³ç»“æœæ—¶å‡ºé”™:', error);
          showToast('è¯­éŸ³å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
      }

      async function sendMessageToAPI(message) {
        try {
          // å¦‚æœå·²ç»åœ¨å“åº”ä¸­ï¼Œå…ˆä¸­æ–­ä¹‹å‰çš„å“åº”
          if (window.isAIResponding) {
            interruptAIResponse();
          }

          // è®¾ç½®å“åº”çŠ¶æ€
          window.isAIResponding = true;
          disableUserInput(true);

          // åˆ›å»ºAbortControllerç”¨äºä¸­æ–­è¯·æ±‚
          window.currentStreamController = new AbortController();

          // è®¾ç½®è¶…æ—¶ä¿æŠ¤ï¼Œé˜²æ­¢ç•Œé¢æ°¸è¿œè¢«é”å®š
          const responseTimeout = setTimeout(() => {
            if (window.isAIResponding) {
              console.log('AIå“åº”è¶…æ—¶ï¼Œé‡ç½®çŠ¶æ€');
              interruptAIResponse();
              showToast('AIå“åº”è¶…æ—¶ï¼Œè¯·é‡è¯•', 'error');
            }
          }, 120000); // 2åˆ†é’Ÿè¶…æ—¶

          // è·å–å½“å‰ä¸Šä¼ çš„æ–‡ä»¶
          const uploadedFiles = window.getCurrentUploadedFiles ? window.getCurrentUploadedFiles() : [];

          // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ï¼ˆåŒ…å«æ–‡ä»¶ä¿¡æ¯ï¼‰
          displayUserMessage(message, uploadedFiles);

          // æ˜¾ç¤ºAIæ¶ˆæ¯å ä½ç¬¦
          const aiMessageElement = showTypingMessage();

          // ä½¿ç”¨æµå¼æ¥å£
          const response = await fetch('/api/chat/stream', {
            method: 'POST',
            headers: getAuthHeaders(),
            body: JSON.stringify({
              message: message,
              chatId: window.currentChatId,
              useThinking: false,
              useSearch: searchToggle.classList.contains('active'),
              files: uploadedFiles // åŒ…å«æ–‡ä»¶ä¿¡æ¯
            }),
            signal: window.currentStreamController.signal // æ·»åŠ ä¸­æ–­ä¿¡å·
          });

          if (!response.ok) {
            throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let aiContent = '';

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');

            for (const line of lines) {
              if (line.startsWith('data: ')) {
                try {
                  const jsonStr = line.slice(6).trim();
                  if (jsonStr) {
                    const data = JSON.parse(jsonStr);
                    if (data.type === 'chatId') {
                      // å¦‚æœè¿™æ˜¯ä¸€ä¸ªæ–°çš„èŠå¤©ï¼Œåˆ·æ–°å†å²è®°å½•
                      const isNewChat = !window.currentChatId;
                      window.currentChatId = data.chatId;
                      if (isNewChat) {
                        // å»¶è¿Ÿåˆ·æ–°å†å²è®°å½•ï¼Œç»™åç«¯ä¸€ç‚¹æ—¶é—´ä¿å­˜
                        setTimeout(() => {
                          loadChatHistory();
                        }, 500);
                      }
                    } else if (data.type === 'weather') {
                      // å¤„ç†å¤©æ°”æ•°æ® - ç«‹å³æ˜¾ç¤ºå¤©æ°”å¡ç‰‡
                      window.currentWeatherData = data.weather;
                      console.log('ğŸŒ¤ï¸ æ”¶åˆ°å¤©æ°”æ•°æ®:', data.weather);

                      // ç¡®ä¿å¤©æ°”å¡ç‰‡èƒ½æ­£ç¡®æ˜¾ç¤ºçš„å¤šé‡ä¿éšœ
                      const tryInsertWeatherCard = (attempt = 0) => {
                        if (data.weather && aiMessageElement) {
                          // æŸ¥æ‰¾æœ€è¿‘çš„AIæ¶ˆæ¯å®¹å™¨
                          const aiMessageContainer = aiMessageElement.closest('.ai-message');
                          if (aiMessageContainer) {
                            insertWeatherCard(aiMessageContainer, data.weather);
                            console.log('ğŸŒ¤ï¸ å¤©æ°”å¡ç‰‡å·²ç«‹å³æ˜¾ç¤º (å°è¯•æ¬¡æ•°:', attempt + 1, ')');
                            // æ»šåŠ¨åˆ°åº•éƒ¨ä»¥æ˜¾ç¤ºå¤©æ°”å¡ç‰‡
                            setTimeout(() => smartScrollToBottom(), 100);
                          } else if (attempt < 3) {
                            // å¦‚æœå®¹å™¨è¿˜æ²¡å‡†å¤‡å¥½ï¼ŒçŸ­æš‚å»¶è¿Ÿåé‡è¯•
                            console.log('â³ AIæ¶ˆæ¯å®¹å™¨è¿˜æœªå‡†å¤‡å¥½ï¼Œ50msåé‡è¯•...');
                            setTimeout(() => tryInsertWeatherCard(attempt + 1), 50);
                          } else {
                            console.warn('âš ï¸ å¤šæ¬¡å°è¯•åä»æœªæ‰¾åˆ°AIæ¶ˆæ¯å®¹å™¨ï¼Œå¤©æ°”å¡ç‰‡æ˜¾ç¤ºå¤±è´¥');
                          }
                        } else if (attempt < 3) {
                          console.log('â³ aiMessageElementè¿˜æœªå‡†å¤‡å¥½ï¼Œ50msåé‡è¯•...');
                          setTimeout(() => tryInsertWeatherCard(attempt + 1), 50);
                        } else {
                          console.warn('âš ï¸ å¤šæ¬¡å°è¯•åaiMessageElementä»æœªå‡†å¤‡å¥½');
                        }
                      };

                      // ç«‹å³å°è¯•æ’å…¥ï¼Œå¦‚æœå¤±è´¥ä¼šè‡ªåŠ¨é‡è¯•
                      tryInsertWeatherCard();
                    } else if (data.type === 'content') {
                      aiContent += data.content;
                      // å®ç°æ‰“å­—æœºæ•ˆæœï¼ˆé˜²æŠ–ä¼˜åŒ–ï¼‰
                      typeWriterEffectDebounced(aiMessageElement, aiContent);
                    } else if (data.type === 'end') {
                      // æµå¼è¾“å‡ºç»“æŸ
                      // å¤©æ°”å¡ç‰‡å·²ç»åœ¨æ”¶åˆ°å¤©æ°”æ•°æ®æ—¶ç«‹å³æ˜¾ç¤ºäº†ï¼Œè¿™é‡Œåªéœ€è¦æ¸…ç†ä¸´æ—¶æ•°æ®
                      if (window.currentWeatherData) {
                        window.currentWeatherData = null; // æ¸…ç†ä¸´æ—¶æ•°æ®
                        console.log('ğŸŒ¤ï¸ æ¸…ç†ä¸´æ—¶å¤©æ°”æ•°æ®');
                      }

                      // ç¡®ä¿æœ€ç»ˆæ¸²æŸ“æ•°å­¦å…¬å¼
                      if (typeWriterDebounceTimer) {
                        clearTimeout(typeWriterDebounceTimer);
                      }
                      // æœ€ç»ˆæ¸²æŸ“æ•°å­¦å…¬å¼
                      if (aiContent.includes('$') || aiContent.includes('\\(') || aiContent.includes('\\[')) {
                        await renderMathSafely(aiMessageElement);
                      }

                      // æ¸…ç†å…‰æ ‡
                      finishTyping(aiMessageElement);

                      // æ¸…ç©ºä¸Šä¼ çš„æ–‡ä»¶
                      if (window.clearUploadedFiles) {
                        window.clearUploadedFiles();
                      }

                      // é‡ç½®å“åº”çŠ¶æ€ï¼Œå…è®¸ç”¨æˆ·å‘é€æ–°æ¶ˆæ¯
                      window.isAIResponding = false;
                      disableUserInput(false);
                      window.currentStreamController = null;
                      // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
                      clearTimeout(responseTimeout);
                      break;
                    } else if (data.type === 'error') {
                      showErrorMessage(data.error);
                      // å‡ºé”™æ—¶ä¹Ÿè¦é‡ç½®çŠ¶æ€
                      interruptAIResponse();
                      // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
                      clearTimeout(responseTimeout);
                      return;
                    }
                  }
                } catch (e) {
                  console.log('è·³è¿‡æ— æ•ˆJSON:', line);
                }
              }
            }
          }

        } catch (error) {
          // æ£€æŸ¥æ˜¯å¦æ˜¯ç”¨æˆ·ä¸»åŠ¨ä¸­æ–­
          if (error.name === 'AbortError') {
            console.log('ç”¨æˆ·ä¸­æ–­äº†AIå“åº”');
            return; // ä¸æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼Œå› ä¸ºæ˜¯ç”¨æˆ·ä¸»åŠ¨ä¸­æ–­
          }

          console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
          showErrorMessage('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•');
          // å‡ºé”™æ—¶é‡ç½®çŠ¶æ€
          interruptAIResponse();
          // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
          clearTimeout(responseTimeout);
        }
      }

      // è·å–æ–‡ä»¶å›¾æ ‡ï¼ˆç”¨äºç”¨æˆ·æ¶ˆæ¯æ˜¾ç¤ºï¼‰
      function getFileIconForDisplay(mimetype, filename) {
        if (mimetype && mimetype.startsWith('image/')) {
          return 'ri-image-line';
        } else if (mimetype && mimetype.startsWith('audio/')) {
          return 'ri-music-line';
        } else if (mimetype && mimetype.startsWith('video/')) {
          return 'ri-video-line';
        } else if (mimetype === 'application/pdf') {
          return 'ri-file-pdf-line';
        } else if (mimetype && (mimetype.includes('word') || filename.endsWith('.doc') || filename.endsWith('.docx'))) {
          return 'ri-file-word-line';
        } else if (mimetype && (mimetype.includes('excel') || filename.endsWith('.xls') || filename.endsWith('.xlsx'))) {
          return 'ri-file-excel-line';
        } else if (mimetype && mimetype.startsWith('text/')) {
          return 'ri-file-text-line';
        } else {
          return 'ri-file-line';
        }
      }

      function displayUserMessage(message, files = [], timestamp = null) {
        const chatContainer = document.getElementById('chat-content');
        const now = timestamp ? new Date(timestamp).toLocaleString('zh-CN') : new Date().toLocaleString('zh-CN');

        // æ¸²æŸ“Markdownæ ¼å¼çš„ç”¨æˆ·æ¶ˆæ¯
        const renderedMessage = renderMarkdown(message);

        // ç”Ÿæˆæ–‡ä»¶æ˜¾ç¤ºHTML
        let filesHTML = '';
        if (files && files.length > 0) {
          filesHTML = `
    <div class="mb-3 space-y-2">
      ${files.map(file => {
            const isImage = file.mimetype && file.mimetype.startsWith('image/');
            const isAudio = file.mimetype && file.mimetype.startsWith('audio/');
            const isVideo = file.mimetype && file.mimetype.startsWith('video/');
            const icon = getFileIconForDisplay(file.mimetype, file.originalname);

            let statusText = '';
            if (isImage) {
              statusText = '<span class="text-xs text-orange-600 ml-2">å·²è¯†åˆ«é™„ä»¶ä¸­çš„æ–‡å­—</span>';
            } else if (isAudio) {
              statusText = '<span class="text-xs text-purple-600 ml-2">éŸ³é¢‘æ–‡ä»¶</span>';
            } else if (isVideo) {
              statusText = '<span class="text-xs text-indigo-600 ml-2">è§†é¢‘æ–‡ä»¶</span>';
            }

            return `
          <div class="flex items-center space-x-2 p-2 bg-white bg-opacity-50 rounded border">
            <i class="${icon} text-blue-500"></i>
            <span class="text-sm text-gray-700">${file.originalname}</span>
            ${statusText}
          </div>
        `;
          }).join('')}
    </div>
  `;
        }

        const userHTML = `
<div class="flex justify-end mb-4">
<div class="max-w-3xl">
<div class="flex justify-end mb-1">
<div class="text-sm text-gray-500">${now}</div>
</div>
<div class="relative group">
<div class="bg-gradient-to-br from-gray-100 via-gray-50 to-white rounded-lg py-3 px-4 text-gray-800 shadow-md hover:shadow-lg transition-shadow duration-300 markdown-content">
${filesHTML}
${renderedMessage}
</div>
</div>
</div>
</div>
`;

        chatContainer.insertAdjacentHTML('beforeend', userHTML);

        // æ¸²æŸ“æ•°å­¦å…¬å¼
        const newMessage = chatContainer.querySelector('.markdown-content:last-of-type');
        if (newMessage) {
          renderMathSafely(newMessage);
        }

        // å¹³æ»‘æ»šåŠ¨åˆ°åº•éƒ¨
        smoothScrollToBottom();
      }

      function showTypingMessage() {
        const chatContainer = document.getElementById('chat-content');
        const now = new Date().toLocaleString('zh-CN');

        const typingHTML = `
<div class="flex justify-start ai-message">
<div class="max-w-3xl">
<div class="flex items-center gap-2 mb-1">
<div class="font-medium">AIå°å­</div>
<div class="text-sm text-gray-500">${now}</div>
</div>
<div class="bg-[#F7F8FA] rounded-lg py-3 px-4 text-gray-800 min-h-[1.5rem] markdown-content">
<span class="ai-content"></span>
<span class="typing-cursor">|</span>
</div>
</div>
</div>
`;

        chatContainer.insertAdjacentHTML('beforeend', typingHTML);
        // å¹³æ»‘æ»šåŠ¨åˆ°åº•éƒ¨
        smoothScrollToBottom();

        // æ·»åŠ å…‰æ ‡é—ªçƒæ•ˆæœï¼ˆä½¿ç”¨CSSåŠ¨ç”»ï¼‰
        const cursor = chatContainer.querySelector('.ai-message:last-child .typing-cursor');

        // è¿”å›æ¶ˆæ¯å…ƒç´ 
        const messageElement = chatContainer.querySelector('.ai-message:last-child .ai-content');
        return messageElement;
      }

      // é˜²æŠ–ç‰ˆæœ¬çš„æ‰“å­—æœºæ•ˆæœ - æç®€é˜²é—ªåŠ¨ç‰ˆæœ¬
      let typeWriterDebounceTimer = null;

      function typeWriterEffectDebounced(element, fullText) {
        // æ¸…é™¤ä¹‹å‰çš„é˜²æŠ–å®šæ—¶å™¨
        if (typeWriterDebounceTimer) {
          clearTimeout(typeWriterDebounceTimer);
        }

        // ç«‹å³æ›´æ–°å†…å®¹ï¼ˆä¸ç®¡æ˜¯å¦æœ‰æ•°å­¦å…¬å¼ï¼‰
        const renderedText = renderMarkdown(fullText);
        element.innerHTML = renderedText;

        // æ£€æµ‹æ˜¯å¦æœ‰æ•°å­¦å…¬å¼éœ€è¦æ¸²æŸ“
        const hasMath = fullText.includes('$') || fullText.includes('\\(') || fullText.includes('\\[');

        if (hasMath) {
          // ç«‹å³æ¸²æŸ“æ•°å­¦å…¬å¼ï¼Œä¸ä½¿ç”¨é˜²æŠ–
          renderMathSafely(element);
        }

        // ç«‹å³æ»šåŠ¨
        setTimeout(() => smartScrollToBottom(), 10);
      }

      async function typeWriterEffect(element, fullText) {
        // å…ˆæ¸²æŸ“Markdownå†…å®¹
        const renderedText = renderMarkdown(fullText);
        element.innerHTML = renderedText;

        // ç›´æ¥æ¸²æŸ“æ•°å­¦å…¬å¼ï¼Œä½†ä½¿ç”¨æ”¹è¿›çš„renderMathSafely
        try {
          await renderMathSafely(element);
        } catch (error) {
          console.warn('æ•°å­¦å…¬å¼æ¸²æŸ“å¤±è´¥:', error);
        }

        // ä½¿ç”¨æ™ºèƒ½æ»šåŠ¨ï¼šåªæœ‰å½“ç”¨æˆ·åœ¨åº•éƒ¨é™„è¿‘æ—¶æ‰è‡ªåŠ¨æ»šåŠ¨
        setTimeout(() => smartScrollToBottom(), 50);
      }

      function finishTyping(element) {
        // æ¸…ç†å…‰æ ‡
        const cursor = element.parentElement.querySelector('.typing-cursor');
        if (cursor) {
          cursor.style.display = 'none';
        }

        // å®Œæˆæ‰“å­—åæ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆæ•°å­¦å…¬å¼å·²åœ¨typeWriterEffectä¸­æ¸²æŸ“ï¼‰
        setTimeout(() => {
          smoothScrollToBottom();
        }, 100);
      }

      // æ˜¾ç¤ºä¸­æ–­æç¤º
      function showInterruptHint() {
        const sendButton = document.getElementById('send-button'); // ä¿®æ­£ï¼šä½¿ç”¨IDé€‰æ‹©å™¨
        if (!sendButton) return;

        // åˆ›å»ºæç¤ºæ¡†
        const hint = document.createElement('div');
        hint.className = 'interrupt-hint fixed z-50 bg-gray-800 text-white px-3 py-2 rounded-lg shadow-xl font-medium text-center';
        hint.innerHTML = `
  <div class="flex items-center justify-center">
    <i class="ri-arrow-down-line mr-1 text-sm"></i>
    <span class="text-sm">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¯åœæ­¢AIå¯¹è¯</span>
  </div>
`;
        hint.style.cssText = `
  animation: bounce-in 0.3s ease-out;
  pointer-events: none;
`;

        // è·å–å‘é€æŒ‰é’®çš„ä½ç½®ï¼Œæç¤ºæ˜¾ç¤ºåœ¨æŒ‰é’®ä¸Šæ–¹
        const buttonRect = sendButton.getBoundingClientRect();
        hint.style.position = 'fixed';
        hint.style.left = (buttonRect.left + buttonRect.width / 2 - 120) + 'px'; // å±…ä¸­å¯¹é½
        hint.style.top = (buttonRect.top - 70) + 'px'; // åœ¨æŒ‰é’®ä¸Šæ–¹

        document.body.appendChild(hint);

        // è®©ä¸­æ–­æŒ‰é’®é—ªçƒæé†’
        sendButton.classList.add('animate-pulse');
        setTimeout(() => {
          sendButton.classList.remove('animate-pulse');
        }, 2000);

        // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
          if (document.body.contains(hint)) {
            hint.style.animation = 'fade-out 0.3s ease-in';
            setTimeout(() => {
              if (document.body.contains(hint)) {
                document.body.removeChild(hint);
              }
            }, 300);
          }
        }, 3000);

        // æ’­æ”¾è½»å¾®çš„éœ‡åŠ¨æ•ˆæœï¼ˆå¦‚æœæ”¯æŒï¼‰
        if (navigator.vibrate) {
          navigator.vibrate(100);
        }
      }

      // æ§åˆ¶ç”¨æˆ·è¾“å…¥çŠ¶æ€
      function disableUserInput(disabled) {
        const messageInput = document.querySelector('.message-input');
        const sendButton = document.getElementById('send-button'); // ä¿®æ­£ï¼šä½¿ç”¨IDé€‰æ‹©å™¨
        const searchToggle = document.getElementById('search-toggle');

        if (disabled) {
          // ä¸ç¦ç”¨è¾“å…¥æ¡†ï¼Œåªæ”¹å˜å¤–è§‚æç¤ºç”¨æˆ·AIæ­£åœ¨å“åº”
          messageInput.placeholder = 'å’ŒAIå°å­èŠå¤©å§...'; // ä¿æŒæ­£å¸¸æç¤ºæ–‡å­—

          // æ·»åŠ è¾¹æ¡†åŠ¨ç”»æ•ˆæœæç¤ºAIæ­£åœ¨å“åº”
          messageInput.style.borderColor = '#3B82F6';
          messageInput.style.boxShadow = '0 0 0 2px rgba(59, 130, 246, 0.1)';
          messageInput.style.animation = 'pulse-border 2s infinite';

          if (sendButton) {
            // ä¿®æ”¹ä¸ºåœæ­¢æŒ‰é’®çš„æ ·å¼
            const sendIcon = sendButton.querySelector('i');
            if (sendIcon) {
              sendIcon.className = 'ri-stop-circle-fill'; // ä½¿ç”¨å®å¿ƒåœæ­¢å›¾æ ‡
            }
            sendButton.title = 'ç‚¹å‡»åœæ­¢AIå›å¤';
            // ä¿æŒè“è‰²èƒŒæ™¯ï¼Œåªæ”¹å˜å›¾æ ‡
          }

          // åˆ‡æ¢æŒ‰é’®ä¿æŒå¯ç”¨ä½†æ·»åŠ æç¤º
          if (searchToggle) {
            searchToggle.title = 'AIå“åº”ä¸­ï¼Œæ–°æ¶ˆæ¯ç”Ÿæ•ˆ';
          }
        } else {
          // æ¢å¤æ­£å¸¸çŠ¶æ€
          messageInput.placeholder = 'å’ŒAIå°å­èŠå¤©å§...';

          // ç§»é™¤åŠ¨ç”»æ•ˆæœ
          messageInput.style.borderColor = '';
          messageInput.style.boxShadow = '';
          messageInput.style.animation = '';

          if (sendButton) {
            // æ¢å¤å‘é€æŒ‰é’®
            const sendIcon = sendButton.querySelector('i');
            if (sendIcon) {
              sendIcon.className = 'ri-send-plane-fill';
            }
            sendButton.title = 'å‘é€æ¶ˆæ¯';
            // åªéœ€è¦æ¢å¤å›¾æ ‡ï¼ŒèƒŒæ™¯è‰²ä¿æŒä¸å˜
          }

          // æ¢å¤åˆ‡æ¢æŒ‰é’®æç¤º
          if (searchToggle) {
            searchToggle.title = 'å¼€å¯è”ç½‘æœç´¢';
          }
        }
      }

      // æ—§çš„displayMessageså‡½æ•°å·²è¢«æµå¼æ˜¾ç¤ºæ›¿ä»£

      function showErrorMessage(error) {
        // ç§»é™¤åŠ è½½æ¶ˆæ¯
        const loadingMessage = document.querySelector('.loading-message');
        if (loadingMessage) {
          loadingMessage.remove();
        }

        const chatContainer = document.getElementById('chat-content');
        const errorHTML = `
<div class="flex justify-start">
<div class="max-w-3xl">
<div class="flex items-center gap-2 mb-1">
<div class="font-medium">AIå°å­</div>
<div class="text-sm text-gray-500">${new Date().toLocaleString('zh-CN')}</div>
</div>
<div class="bg-red-50 border border-red-200 rounded-lg py-3 px-4 text-red-800">
âŒ ${error}
</div>
</div>
</div>
`;
        chatContainer.insertAdjacentHTML('beforeend', errorHTML);
        // å¹³æ»‘æ»šåŠ¨åˆ°åº•éƒ¨
        smoothScrollToBottom();
      }

      function bindThinkingToggle() {
        document.querySelectorAll('.thinking-toggle').forEach(button => {
          button.addEventListener('click', function () {
            const thinkingProcess = this.nextElementSibling;
            thinkingProcess.classList.toggle('expanded');
            // æ›´æ–°ç®­å¤´å›¾æ ‡
            const arrowIcon = this.querySelector('.ri-arrow-down-s-line, .ri-arrow-up-s-line');
            if (thinkingProcess.classList.contains('expanded')) {
              arrowIcon.classList.replace('ri-arrow-down-s-line', 'ri-arrow-up-s-line');
            } else {
              arrowIcon.classList.replace('ri-arrow-up-s-line', 'ri-arrow-down-s-line');
            }
          });
        });
      }

      // åŠ è½½èŠå¤©å†å²
      async function loadChatHistory() {
        try {
          const response = await fetch('/api/chat/history', {
            headers: getAuthHeaders()
          });
          const result = await response.json();
          if (result.success) {
            updateHistoryList(result.data);
          } else if (result.error && (result.error.includes('ä»¤ç‰Œ') || result.error.includes('ç™»å½•'))) {
            handleAuthError(result);
          }
        } catch (error) {
          console.error('åŠ è½½å†å²å¤±è´¥:', error);
        }
      }

      function updateHistoryList(history) {
        const historyContainer = document.getElementById('history-container');

        if (!history || (Object.keys(history).length === 0 &&
          (!history['å½“å¤©'] || history['å½“å¤©'].length === 0) &&
          (!history['ä¸ƒå¤©ä»¥å†…'] || history['ä¸ƒå¤©ä»¥å†…'].length === 0) &&
          (!history['ä¸€ä¸ªæœˆä»¥å†…'] || history['ä¸€ä¸ªæœˆä»¥å†…'].length === 0) &&
          (!history['æ›´æ—©'] || Object.keys(history['æ›´æ—©']).length === 0))) {
          historyContainer.innerHTML = `
    <div class="p-3 text-center text-gray-500 text-sm">
      <i class="ri-chat-3-line mr-1"></i>
      æš‚æ— å†å²å¯¹è¯
    </div>
  `;
          return;
        }

        let historyHTML = '';

        // å½“å¤©
        if (history['å½“å¤©'] && history['å½“å¤©'].length > 0) {
          historyHTML += `
    <div class="p-3">
      <div class="text-sm text-gray-500 mb-2 flex items-center gap-1">
        <i class="ri-time-line"></i>
        å½“å¤©
      </div>
      ${history['å½“å¤©'].map((chat, index) => `
        <div class="history-item py-2 px-3 rounded text-sm mb-1 cursor-pointer hover:bg-gray-50 ${index === 0 ? 'active-chat bg-blue-50 text-blue-700' : ''}" data-chat-id="${chat.id}">
          <div class="flex items-center justify-between group">
            <div class="truncate flex-1 pr-2">${chat.title}</div>
            <div class="opacity-0 group-hover:opacity-100 transition-opacity">
              <button class="delete-chat-btn w-6 h-6 flex items-center justify-center text-red-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors" data-chat-id="${chat.id}" title="åˆ é™¤å¯¹è¯">
                <i class="ri-delete-bin-line text-xs"></i>
              </button>
            </div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
        }

        // ä¸ƒå¤©ä»¥å†…
        if (history['ä¸ƒå¤©ä»¥å†…'] && history['ä¸ƒå¤©ä»¥å†…'].length > 0) {
          historyHTML += `
    <div class="p-3">
      <div class="text-sm text-gray-500 mb-2 flex items-center gap-1">
        <i class="ri-calendar-line"></i>
        ä¸ƒå¤©ä»¥å†…
      </div>
      ${history['ä¸ƒå¤©ä»¥å†…'].map(chat => `
        <div class="history-item py-2 px-3 rounded text-sm mb-1 cursor-pointer hover:bg-gray-50" data-chat-id="${chat.id}">
          <div class="flex items-center justify-between group">
            <div class="truncate flex-1 pr-2">${chat.title}</div>
            <div class="opacity-0 group-hover:opacity-100 transition-opacity">
              <button class="delete-chat-btn w-6 h-6 flex items-center justify-center text-red-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors" data-chat-id="${chat.id}" title="åˆ é™¤å¯¹è¯">
                <i class="ri-delete-bin-line text-xs"></i>
              </button>
            </div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
        }

        // ä¸€ä¸ªæœˆä»¥å†…
        if (history['ä¸€ä¸ªæœˆä»¥å†…'] && history['ä¸€ä¸ªæœˆä»¥å†…'].length > 0) {
          historyHTML += `
    <div class="p-3">
      <div class="text-sm text-gray-500 mb-2 flex items-center gap-1">
        <i class="ri-calendar-2-line"></i>
        ä¸€ä¸ªæœˆä»¥å†…
      </div>
      ${history['ä¸€ä¸ªæœˆä»¥å†…'].map(chat => `
        <div class="history-item py-2 px-3 rounded text-sm mb-1 cursor-pointer hover:bg-gray-50" data-chat-id="${chat.id}">
          <div class="flex items-center justify-between group">
            <div class="truncate flex-1 pr-2">${chat.title}</div>
            <div class="opacity-0 group-hover:opacity-100 transition-opacity">
              <button class="delete-chat-btn w-6 h-6 flex items-center justify-center text-red-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors" data-chat-id="${chat.id}" title="åˆ é™¤å¯¹è¯">
                <i class="ri-delete-bin-line text-xs"></i>
              </button>
            </div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
        }

        // æ›´æ—©çš„å¯¹è¯ï¼ˆæŒ‰æœˆä»½åˆ†ç»„ï¼‰
        if (history['æ›´æ—©'] && Object.keys(history['æ›´æ—©']).length > 0) {
          Object.keys(history['æ›´æ—©']).sort().reverse().forEach(monthKey => {
            if (history['æ›´æ—©'][monthKey] && history['æ›´æ—©'][monthKey].length > 0) {
              historyHTML += `
        <div class="p-3">
          <div class="text-sm text-gray-500 mb-2 flex items-center gap-1">
            <i class="ri-history-line"></i>
            ${monthKey}
          </div>
          ${history['æ›´æ—©'][monthKey].map(chat => `
            <div class="history-item py-2 px-3 rounded text-sm mb-1 cursor-pointer hover:bg-gray-50" data-chat-id="${chat.id}">
              <div class="flex items-center justify-between group">
                <div class="truncate flex-1 pr-2">${chat.title}</div>
                <div class="opacity-0 group-hover:opacity-100 transition-opacity">
                  <button class="delete-chat-btn w-6 h-6 flex items-center justify-center text-red-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors" data-chat-id="${chat.id}" title="åˆ é™¤å¯¹è¯">
                    <i class="ri-delete-bin-line text-xs"></i>
                  </button>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
            }
          });
        }

        if (historyHTML === '') {
          historyHTML = `
    <div class="p-3 text-center text-gray-500 text-sm">
      <i class="ri-chat-3-line mr-1"></i>
      æš‚æ— å†å²å¯¹è¯
    </div>
  `;
        }

        historyContainer.innerHTML = historyHTML;

        // ç»‘å®šç‚¹å‡»äº‹ä»¶
        bindHistoryItemEvents();
      }

      // ç»‘å®šå†å²è®°å½•é¡¹ç‚¹å‡»äº‹ä»¶
      function bindHistoryItemEvents() {
        const historyItems = document.querySelectorAll('.history-item');
        const deleteButtons = document.querySelectorAll('.delete-chat-btn');

        // ç»‘å®šå†å²é¡¹ç‚¹å‡»äº‹ä»¶
        historyItems.forEach(item => {
          item.addEventListener('click', async function (e) {
            // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ é™¤æŒ‰é’®ï¼Œä¸æ‰§è¡Œå†å²é¡¹ç‚¹å‡»é€»è¾‘
            if (e.target.closest('.delete-chat-btn')) {
              return;
            }

            // ç§»é™¤æ‰€æœ‰æ´»è·ƒçŠ¶æ€
            historyItems.forEach(i => i.classList.remove('active-chat'));
            // æ·»åŠ å½“å‰é¡¹çš„æ´»è·ƒçŠ¶æ€
            this.classList.add('active-chat');

            // è·å–èŠå¤©ID
            const chatId = this.getAttribute('data-chat-id');
            if (chatId) {
              await loadChatMessages(chatId);
            }

            // æ˜¾ç¤ºèŠå¤©å†…å®¹åŒºåŸŸ
            document.getElementById('welcome-message').classList.add('hidden');
            document.getElementById('chat-content').classList.remove('hidden');
            document.getElementById('new-chat-button').classList.remove('hidden');

            // ç§»åŠ¨ç«¯ç‚¹å‡»å†å²å¯¹è¯åè‡ªåŠ¨å…³é—­ä¾§è¾¹æ 
            if (window.innerWidth <= 768) {
              window.hideSidebar();
            }
          });
        });

        // ç»‘å®šåˆ é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        deleteButtons.forEach(button => {
          button.addEventListener('click', async function (e) {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡

            const chatId = this.getAttribute('data-chat-id');
            const historyItem = this.closest('.history-item');
            const chatTitle = historyItem.querySelector('.truncate').textContent;

            // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
            if (await showDeleteConfirmation(chatTitle)) {
              await deleteChatById(chatId);
            }
          });
        });
      }

      // åŠ è½½ç‰¹å®šèŠå¤©çš„æ¶ˆæ¯
      async function loadChatMessages(chatId) {
        try {
          const response = await fetch(`/api/chat/${chatId}`, {
            headers: getAuthHeaders()
          });
          const result = await response.json();
          if (result.success) {
            displayChatMessages(result.data.messages);
            // è®¾ç½®å½“å‰èŠå¤©ID
            window.currentChatId = chatId;
          } else if (result.error && (result.error.includes('ä»¤ç‰Œ') || result.error.includes('ç™»å½•'))) {
            handleAuthError(result);
          }
        } catch (error) {
          console.error('åŠ è½½èŠå¤©æ¶ˆæ¯å¤±è´¥:', error);
          showErrorMessage('åŠ è½½èŠå¤©è®°å½•å¤±è´¥');
        }
      }

      // æ˜¾ç¤ºèŠå¤©æ¶ˆæ¯ - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œå‡å°‘é‡å¤æ¸²æŸ“
      function displayChatMessages(messages) {
        const chatContent = document.getElementById('chat-content');
        chatContent.innerHTML = '';

        // æ ‡è®°æ­£åœ¨åŠ è½½å†å²æ¶ˆæ¯
        window.isLoadingHistory = true;

        messages.forEach(message => {
          if (message.role === 'user') {
            displayUserMessage(message.content, message.attachments || [], message.timestamp);
          } else if (message.role === 'assistant') {
            displayAssistantMessage(message.content, message.thinking, message.searchUsed, message.searchResultsCount, message.weather, message.timestamp);
          }
        });

        // æ ‡è®°å†å²æ¶ˆæ¯åŠ è½½å®Œæˆ
        window.isLoadingHistory = false;

        // æ‰¹é‡æ¸²æŸ“æ‰€æœ‰æœªæ¸²æŸ“çš„æ•°å­¦å…¬å¼
        setTimeout(() => {
          const mathElements = chatContent.querySelectorAll('.markdown-content');
          let pendingRenders = 0;

          mathElements.forEach(element => {
            // åªæ¸²æŸ“æœªå¤„ç†è¿‡çš„å…ƒç´ 
            if (!element.dataset.mathRendered && !element.dataset.mathRendering) {
              pendingRenders++;
              renderMathSafely(element).then(() => {
                pendingRenders--;
                // æ‰€æœ‰æ•°å­¦å…¬å¼æ¸²æŸ“å®Œæˆåæ»šåŠ¨åˆ°åº•éƒ¨
                if (pendingRenders === 0) {
                  setTimeout(() => smoothScrollToBottom(), 100);
                }
              }).catch(() => {
                pendingRenders--;
              });
            }
          });

          // å¦‚æœæ²¡æœ‰éœ€è¦æ¸²æŸ“çš„å…¬å¼ï¼Œç›´æ¥æ»šåŠ¨
          if (pendingRenders === 0) {
            setTimeout(() => smoothScrollToBottom(), 100);
          }
        }, 100);
      }

      // æ˜¾ç¤ºåŠ©æ‰‹æ¶ˆæ¯
      function displayAssistantMessage(content, thinking, searchUsed, searchResultsCount, weather, timestamp = null) {
        const chatContainer = document.getElementById('chat-content');
        const now = timestamp ? new Date(timestamp).toLocaleString('zh-CN') : new Date().toLocaleString('zh-CN');

        // æ¸²æŸ“Markdownæ ¼å¼çš„åŠ©æ‰‹æ¶ˆæ¯
        const renderedMessage = renderMarkdown(content);

        let thinkingHTML = '';
        if (thinking) {
          thinkingHTML = `
    <div class="mb-3">
      <button class="thinking-toggle flex items-center gap-2 text-sm text-blue-600 hover:text-blue-700 bg-blue-50 hover:bg-blue-100 px-3 py-1.5 rounded-lg transition-colors">
        <i class="ri-brain-line"></i>
        <span>æ€è€ƒè¿‡ç¨‹</span>
        <i class="ri-arrow-down-s-line"></i>
      </button>
      <div class="thinking-process mt-2 bg-blue-50 rounded-lg p-3 text-sm text-blue-800">
        ${thinking.content}
      </div>
    </div>
  `;
        }

        let searchHTML = '';
        if (searchUsed) {
          searchHTML = `
    <div class="mb-3 text-xs text-gray-500 flex items-center gap-1">
      <i class="ri-search-line"></i>
      <span>å·²è”ç½‘æœç´¢${searchResultsCount ? ` (${searchResultsCount}æ¡ç»“æœ)` : ''}</span>
    </div>
  `;
        }

        // å¤©æ°”å¡ç‰‡HTML
        let weatherHTML = '';
        if (weather && weather.type === 'weather_card') {
          const { city, temperature, description, details } = weather.data;
          const weatherIcon = getWeatherIcon(description);

          weatherHTML = `
    <div class="weather-card mb-3 bg-gradient-to-r from-blue-400 to-blue-500 text-white rounded-xl p-4 shadow-lg">
      <div class="flex items-center justify-between mb-3">
        <div>
          <h3 class="text-lg font-medium">${city}</h3>
          <p class="text-2xl font-light">${temperature}Â°C</p>
          <p class="text-sm opacity-90">${description}</p>
        </div>
        <div class="text-4xl opacity-90">
          <i class="${weatherIcon}"></i>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-3 pt-3 border-t border-white/20">
        ${details.map(detail => `
          <div class="flex items-center gap-2">
            <i class="${getDetailIcon(detail.icon)} text-sm opacity-70"></i>
            <span class="text-sm opacity-90">${detail.label}</span>
            <span class="text-sm font-medium ml-auto">${detail.value}</span>
          </div>
        `).join('')}
      </div>
    </div>
  `;
        }

        const assistantHTML = `
  <div class="flex justify-start ai-message">
    <div class="max-w-3xl">
      <div class="flex items-center gap-2 mb-1">
        <div class="font-medium">AIå°å­</div>
        <div class="text-sm text-gray-500">${now}</div>
      </div>
      ${thinkingHTML}
      ${searchHTML}
      ${weatherHTML}
      <div class="bg-[#F7F8FA] rounded-lg py-3 px-4 text-gray-800 markdown-content">
        ${renderedMessage}
      </div>
    </div>
  </div>
`;

        chatContainer.insertAdjacentHTML('beforeend', assistantHTML);

        // æ¸²æŸ“æ•°å­¦å…¬å¼
        const newMessage = chatContainer.querySelector('.ai-message:last-child .markdown-content');
        if (newMessage) {
          renderMathSafely(newMessage);
        }

        // åªæœ‰å®æ—¶æ¶ˆæ¯æ‰éœ€è¦ç«‹å³æ»šåŠ¨
        const isLiveMessage = !window.isLoadingHistory;
        if (isLiveMessage) {
          smoothScrollToBottom();
        }

        // ç»‘å®šæ€è€ƒè¿‡ç¨‹åˆ‡æ¢äº‹ä»¶
        bindThinkingToggle();
      }

      // è·å–å¤©æ°”å›¾æ ‡
      function getWeatherIcon(description) {
        const iconMap = {
          'æ™´': 'ri-sun-line',
          'æ™´æœ—': 'ri-sun-line',
          'å¤šäº‘': 'ri-cloudy-line',
          'é˜´': 'ri-cloudy-2-line',
          'é›¨': 'ri-rainy-line',
          'å°é›¨': 'ri-drizzle-line',
          'å¤§é›¨': 'ri-heavy-showers-line',
          'é›ª': 'ri-snowy-line',
          'é›¾': 'ri-mist-line',
          'éœ¾': 'ri-haze-2-line'
        };

        for (const [key, icon] of Object.entries(iconMap)) {
          if (description.includes(key)) {
            return icon;
          }
        }

        return 'ri-sun-line'; // é»˜è®¤å›¾æ ‡
      }

      // è·å–å¤©æ°”è¯¦æƒ…å›¾æ ‡
      function getDetailIcon(iconType) {
        const iconMap = {
          'temperature': 'ri-temp-hot-line',
          'water': 'ri-water-percent-line',
          'wind': 'ri-windy-line',
          'leaf': 'ri-leaf-line',
          'eye': 'ri-eye-line'
        };

        return iconMap[iconType] || 'ri-information-line';
      }

      // æ’å…¥å¤©æ°”å¡ç‰‡åˆ°æ¶ˆæ¯ä¸­ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
      function insertWeatherCard(messageContainer, weatherData) {
        if (!weatherData || weatherData.type !== 'weather_card') {
          console.warn('âš ï¸ æ— æ•ˆçš„å¤©æ°”æ•°æ®:', weatherData);
          return;
        }

        // æ£€æŸ¥æ˜¯å¦å·²ç»æ’å…¥è¿‡å¤©æ°”å¡ç‰‡
        if (messageContainer.querySelector('.weather-card')) {
          console.log('ğŸŒ¤ï¸ å¤©æ°”å¡ç‰‡å·²å­˜åœ¨ï¼Œè·³è¿‡é‡å¤æ’å…¥');
          return;
        }

        const { city, temperature, description, details, meta } = weatherData.data;
        const weatherIcon = getWeatherIcon(description);
        const gradientClass = getWeatherGradient(description);

        const weatherHTML = `
    <div class="weather-card mb-3 ${gradientClass} text-white rounded-xl p-4 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
      <div class="flex items-center justify-between mb-3">
        <div class="flex-1">
          <div class="flex items-center gap-2 mb-1">
            <h3 class="text-lg font-medium">${city}</h3>
            <span class="text-xs bg-white/20 px-2 py-1 rounded-full">å®æ—¶</span>
          </div>
          <p class="text-3xl font-light mb-1">${temperature}Â°C</p>
          <p class="text-sm opacity-90 flex items-center gap-1">
            <i class="${weatherIcon} text-lg"></i>
            ${description}
          </p>
        </div>
        <div class="text-5xl opacity-80 weather-icon-animation">
          <i class="${weatherIcon}"></i>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-3 pt-3 border-t border-white/20">
        ${details.map(detail => `
          <div class="flex items-center gap-2 group hover:bg-white/10 p-2 rounded-lg transition-colors">
            <i class="${getDetailIcon(detail.icon)} text-sm opacity-70 group-hover:opacity-90 transition-opacity"></i>
            <div class="flex-1">
              <span class="text-xs opacity-70 block">${detail.label}</span>
              <span class="text-sm font-medium ${detail.color || ''}">${detail.value}</span>
            </div>
          </div>
        `).join('')}
      </div>
      ${meta ? `
        <div class="mt-3 pt-3 border-t border-white/20 flex justify-between items-center text-xs opacity-70">
          <span>æ›´æ–°æ—¶é—´: ${meta.updateTime}</span>
          <span>æ•°æ®æ¥æº: ${meta.source === 'web_search' ? 'è”ç½‘æœç´¢' : meta.source === 'mock_api' ? 'æ¨¡æ‹Ÿæ•°æ®' : 'å®æ—¶æ•°æ®'}</span>
        </div>
      ` : ''}
    </div>
  `;

        // æŸ¥æ‰¾æ’å…¥ä½ç½®ï¼šä¼˜å…ˆæ’å…¥åˆ°æ¶ˆæ¯å†…å®¹ä¹‹å‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ’å…¥åˆ°æ¶ˆæ¯å¤´éƒ¨
        const contentDiv = messageContainer.querySelector('.markdown-content');
        if (contentDiv) {
          console.log('ğŸŒ¤ï¸ åœ¨markdown-contentä¹‹å‰æ’å…¥å¤©æ°”å¡ç‰‡');
          contentDiv.insertAdjacentHTML('beforebegin', weatherHTML);
        } else {
          // å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥æ’å…¥åˆ°æ¶ˆæ¯å®¹å™¨çš„é¡¶éƒ¨
          console.log('ğŸŒ¤ï¸ åœ¨æ¶ˆæ¯å®¹å™¨é¡¶éƒ¨æ’å…¥å¤©æ°”å¡ç‰‡');
          messageContainer.insertAdjacentHTML('afterbegin', weatherHTML);
        }

        // æ·»åŠ å…¥åœºåŠ¨ç”»
        const weatherCard = messageContainer.querySelector('.weather-card');
        if (weatherCard) {
          weatherCard.style.opacity = '0';
          weatherCard.style.transform = 'translateY(20px)';

          requestAnimationFrame(() => {
            weatherCard.style.transition = 'all 0.5s ease-out';
            weatherCard.style.opacity = '1';
            weatherCard.style.transform = 'translateY(0)';
          });

          console.log('âœ… å¤©æ°”å¡ç‰‡æ’å…¥æˆåŠŸå¹¶åº”ç”¨åŠ¨ç”»');
        } else {
          console.error('âŒ å¤©æ°”å¡ç‰‡æ’å…¥å¤±è´¥');
        }
      }

      // æ ¹æ®å¤©æ°”çŠ¶å†µè·å–æ¸å˜è‰²
      function getWeatherGradient(description) {
        if (description.includes('æ™´')) {
          return 'bg-gradient-to-br from-yellow-400 via-orange-400 to-red-400';
        } else if (description.includes('é›¨')) {
          return 'bg-gradient-to-br from-blue-600 via-blue-500 to-indigo-500';
        } else if (description.includes('é›ª')) {
          return 'bg-gradient-to-br from-gray-400 via-gray-300 to-blue-300';
        } else if (description.includes('é›¾') || description.includes('éœ¾')) {
          return 'bg-gradient-to-br from-gray-500 via-gray-400 to-gray-600';
        } else if (description.includes('äº‘') || description.includes('é˜´')) {
          return 'bg-gradient-to-br from-gray-500 via-blue-400 to-blue-500';
        }
        // é»˜è®¤è“è‰²æ¸å˜
        return 'bg-gradient-to-br from-blue-400 via-blue-500 to-indigo-500';
      }

      // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
      function showDeleteConfirmation(chatTitle) {
        return new Promise((resolve) => {
          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
          modal.innerHTML = `
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-md mx-4 modal-enter">
      <div class="flex items-center mb-4">
        <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center mr-3">
          <i class="ri-delete-bin-line text-red-600"></i>
        </div>
        <h3 class="text-lg font-semibold text-gray-900">åˆ é™¤å¯¹è¯</h3>
      </div>
      <p class="text-gray-600 mb-6">
        ç¡®å®šè¦åˆ é™¤å¯¹è¯ "<span class="font-medium">${chatTitle}</span>" å—ï¼Ÿ<br>
        <span class="text-sm text-red-500">æ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</span>
      </p>
      <div class="flex justify-end gap-3">
        <button class="cancel-btn px-4 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors">
          å–æ¶ˆ
        </button>
        <button class="confirm-btn px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
          åˆ é™¤
        </button>
      </div>
    </div>
  `;

          document.body.appendChild(modal);

          // ç»‘å®šäº‹ä»¶
          modal.querySelector('.cancel-btn').addEventListener('click', () => {
            document.body.removeChild(modal);
            resolve(false);
          });

          modal.querySelector('.confirm-btn').addEventListener('click', () => {
            document.body.removeChild(modal);
            resolve(true);
          });

          // ç‚¹å‡»èƒŒæ™¯å…³é—­
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              document.body.removeChild(modal);
              resolve(false);
            }
          });

          // ESCé”®å…³é—­
          const handleEscape = (e) => {
            if (e.key === 'Escape') {
              document.body.removeChild(modal);
              document.removeEventListener('keydown', handleEscape);
              resolve(false);
            }
          };
          document.addEventListener('keydown', handleEscape);
        });
      }

      // åˆ é™¤èŠå¤©
      async function deleteChatById(chatId) {
        try {
          // æ˜¾ç¤ºåˆ é™¤loadingçŠ¶æ€
          const historyItem = document.querySelector(`[data-chat-id="${chatId}"]`);
          const deleteBtn = historyItem.querySelector('.delete-chat-btn');
          const originalContent = deleteBtn.innerHTML;
          deleteBtn.innerHTML = '<i class="ri-loader-4-line animate-spin text-xs"></i>';
          deleteBtn.disabled = true;

          const response = await fetch(`/api/chat/${chatId}`, {
            method: 'DELETE',
            headers: getAuthHeaders()
          });

          const result = await response.json();

          if (result.success) {
            // åˆ é™¤æˆåŠŸï¼Œåˆ·æ–°å†å²è®°å½•
            await loadChatHistory();

            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ­£åœ¨æŸ¥çœ‹çš„èŠå¤©ï¼Œå›åˆ°æ¬¢è¿é¡µé¢
            if (window.currentChatId === chatId) {
              startNewChat();
            }

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showToast('å¯¹è¯åˆ é™¤æˆåŠŸ', 'success');
          } else {
            throw new Error(result.error || 'åˆ é™¤å¤±è´¥');
          }

        } catch (error) {
          console.error('åˆ é™¤èŠå¤©å¤±è´¥:', error);

          // æ¢å¤åˆ é™¤æŒ‰é’®çŠ¶æ€
          const historyItem = document.querySelector(`[data-chat-id="${chatId}"]`);
          if (historyItem) {
            const deleteBtn = historyItem.querySelector('.delete-chat-btn');
            deleteBtn.innerHTML = '<i class="ri-delete-bin-line text-xs"></i>';
            deleteBtn.disabled = false;
          }

          showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
        }
      }

      // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
      function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full ${type === 'success' ? 'bg-green-500 text-white' :
          type === 'error' ? 'bg-red-500 text-white' :
            'bg-blue-500 text-white'
          }`;
        toast.textContent = message;

        document.body.appendChild(toast);

        // æ˜¾ç¤ºåŠ¨ç”»
        requestAnimationFrame(() => {
          toast.style.transform = 'translateX(0)';
        });

        // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
          toast.style.transform = 'translateX(full)';
          setTimeout(() => {
            if (document.body.contains(toast)) {
              document.body.removeChild(toast);
            }
          }, 300);
        }, 3000);
      }

      // å¼€å§‹æ–°å¯¹è¯
      async function startNewChat() {
        try {
          // å¦‚æœå½“å‰æœ‰æ­£åœ¨è¿›è¡Œçš„å¯¹è¯ï¼Œå…ˆç¡®ä¿å®ƒå·²ç»ä¿å­˜
          if (window.currentChatId) {
            console.log('ä¿å­˜å½“å‰å¯¹è¯åˆ°å†å²è®°å½•:', window.currentChatId);

            // ç»™æœåŠ¡å™¨ä¸€ç‚¹æ—¶é—´ç¡®ä¿æœ€åçš„æ¶ˆæ¯å·²ç»ä¿å­˜
            await new Promise(resolve => setTimeout(resolve, 100));

            // åˆ·æ–°å†å²è®°å½•ä»¥æ˜¾ç¤ºåˆšä¿å­˜çš„å¯¹è¯
            await loadChatHistory();
          }

          // ç§»é™¤æ‰€æœ‰å†å²é¡¹çš„æ´»è·ƒçŠ¶æ€
          const historyItems = document.querySelectorAll('.history-item');
          historyItems.forEach(i => i.classList.remove('active-chat'));

          // æ¸…ç©ºèŠå¤©å†…å®¹åŒºåŸŸï¼Œç¡®ä¿åªæ˜¾ç¤ºæ–°å¯¹è¯
          const chatContent = document.getElementById('chat-content');
          chatContent.innerHTML = ''; // æ¸…ç©ºæ‰€æœ‰ä¹‹å‰çš„èŠå¤©æ¶ˆæ¯

          // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯ï¼Œéšè—èŠå¤©å†…å®¹å’Œæ–°å¯¹è¯æŒ‰é’®
          document.getElementById('welcome-message').classList.remove('hidden');
          document.getElementById('chat-content').classList.add('hidden');
          document.getElementById('new-chat-button').classList.add('hidden');

          // æ¸…ç©ºè¾“å…¥æ¡†
          const messageInput = document.querySelector('.message-input');
          messageInput.value = '';
          messageInput.style.height = '48px';
          messageInput.focus();

          // æ¸…é™¤å½“å‰èŠå¤©ID
          const previousChatId = window.currentChatId;
          window.currentChatId = null;

          // æ·»åŠ åŠ¨ç”»æ•ˆæœ
          const welcomeDiv = document.getElementById('welcome-message');
          welcomeDiv.style.opacity = '0';
          welcomeDiv.style.transform = 'translateY(20px)';
          requestAnimationFrame(() => {
            welcomeDiv.style.transition = 'all 0.5s ease';
            welcomeDiv.style.opacity = '1';
            welcomeDiv.style.transform = 'translateY(0)';
          });

          // å¦‚æœæœ‰ä¹‹å‰çš„å¯¹è¯ï¼Œæ˜¾ç¤ºæç¤º
          if (previousChatId) {
            showToast('å½“å‰å¯¹è¯å·²ä¿å­˜åˆ°å†å²è®°å½•', 'success');
          }

        } catch (error) {
          console.error('å¼€å¯æ–°å¯¹è¯æ—¶å‡ºé”™:', error);
          // å³ä½¿å‡ºé”™ä¹Ÿè¦å…è®¸ç”¨æˆ·å¼€å¯æ–°å¯¹è¯
          window.currentChatId = null;
          showToast('å¼€å¯æ–°å¯¹è¯', 'info');
        }
      }

      // åœ¨ç¬¬ä¸€ä¸ªDOMContentLoadedä¸­æ·»åŠ æ–°å¯¹è¯æŒ‰é’®äº‹ä»¶ç»‘å®š
      // é¡µé¢åŠ è½½æ—¶è·å–å†å²å¹¶ç»‘å®šæŒ‰é’®äº‹ä»¶
      setTimeout(() => {
        loadChatHistory();

        // åˆå§‹åŒ–çŠ¶æ€
        window.isAIResponding = false;
        disableUserInput(false);

        // æ–°å¯¹è¯æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - ä½¿ç”¨ç±»åé€‰æ‹©å™¨
        const newChatButtons = document.querySelectorAll('.new-chat-btn');
        newChatButtons.forEach(button => {
          button.addEventListener('click', async function (e) {
            e.preventDefault();
            console.log('æ–°å¯¹è¯æŒ‰é’®è¢«ç‚¹å‡»');

            // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            this.disabled = true;
            const originalText = this.querySelector('span').textContent;
            this.querySelector('span').textContent = 'ä¿å­˜ä¸­...';

            try {
              await startNewChat();

              // ç§»åŠ¨ç«¯ç‚¹å‡»æ–°å¯¹è¯åè‡ªåŠ¨å…³é—­ä¾§è¾¹æ 
              if (window.innerWidth <= 768) {
                window.hideSidebar();
              }
            } finally {
              // æ¢å¤æŒ‰é’®çŠ¶æ€
              this.disabled = false;
              this.querySelector('span').textContent = originalText;
            }
          });
        });

        // ä¹Ÿå¯ä»¥é€šè¿‡IDå•ç‹¬ç»‘å®š
        const sidebarNewChatBtn = document.getElementById('sidebar-new-chat-btn');
        const chatNewChatBtn = document.getElementById('chat-new-chat-btn');

        if (sidebarNewChatBtn) {
          sidebarNewChatBtn.addEventListener('click', async function (e) {
            e.preventDefault();
            console.log('ä¾§è¾¹æ æ–°å¯¹è¯æŒ‰é’®è¢«ç‚¹å‡»');

            // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            this.disabled = true;
            const originalText = this.querySelector('span').textContent;
            this.querySelector('span').textContent = 'ä¿å­˜ä¸­...';

            try {
              await startNewChat();

              // ç§»åŠ¨ç«¯ç‚¹å‡»æ–°å¯¹è¯åè‡ªåŠ¨å…³é—­ä¾§è¾¹æ 
              if (window.innerWidth <= 768) {
                window.hideSidebar();
              }
            } finally {
              // æ¢å¤æŒ‰é’®çŠ¶æ€
              this.disabled = false;
              this.querySelector('span').textContent = originalText;
            }
          });
        }

        if (chatNewChatBtn) {
          chatNewChatBtn.addEventListener('click', async function (e) {
            e.preventDefault();
            console.log('èŠå¤©åŒºåŸŸæ–°å¯¹è¯æŒ‰é’®è¢«ç‚¹å‡»');

            // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            this.disabled = true;
            const originalText = this.querySelector('span').textContent;
            this.querySelector('span').textContent = 'ä¿å­˜ä¸­...';

            try {
              await startNewChat();

              // ç§»åŠ¨ç«¯ç‚¹å‡»æ–°å¯¹è¯åè‡ªåŠ¨å…³é—­ä¾§è¾¹æ ï¼ˆè¿™ä¸ªæŒ‰é’®åœ¨ä¸»åŒºåŸŸï¼Œä¸€èˆ¬ä¸éœ€è¦å…³é—­ä¾§è¾¹æ ï¼‰
              // if (window.innerWidth <= 768) {
              //   hideSidebar();
              // }
            } finally {
              // æ¢å¤æŒ‰é’®çŠ¶æ€
              this.disabled = false;
              this.querySelector('span').textContent = originalText;
            }
          });
        }
      }, 100);

    }); // ç»“æŸç¬¬ä¸€ä¸ªDOMContentLoaded

    // æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
    document.addEventListener('DOMContentLoaded', function () {
      // æ–‡ä»¶ä¸Šä¼ ç›¸å…³å…ƒç´ 
      const attachmentButton = document.querySelector('i.ri-attachment-2').parentElement;
      const fileInput = document.getElementById('file-input');
      const uploadedFilesDisplay = document.getElementById('uploaded-files-display');

      let currentUploadedFiles = []; // å½“å‰ä¼šè¯ä¸­ä¸Šä¼ çš„æ–‡ä»¶

      // é™„ä»¶æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - ç›´æ¥è§¦å‘æ–‡ä»¶é€‰æ‹©
      attachmentButton.addEventListener('click', function () {
        fileInput.click();
      });

      // æ–‡ä»¶è¾“å…¥å˜åŒ– - ç›´æ¥ä¸Šä¼ æ–‡ä»¶
      fileInput.addEventListener('change', function () {
        const files = Array.from(this.files);
        if (files.length > 0) {
          uploadFiles(files);
        }
        // æ¸…ç©ºinputä»¥å…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
        this.value = '';
      });

      // æ‹–æ‹½ä¸Šä¼ åˆ°æ•´ä¸ªè¾“å…¥åŒºåŸŸ
      const inputContainer = document.querySelector('.relative');

      inputContainer.addEventListener('dragover', function (e) {
        e.preventDefault();
        e.stopPropagation();
        inputContainer.classList.add('border-2', 'border-blue-500', 'border-dashed');
      });

      inputContainer.addEventListener('dragleave', function (e) {
        e.preventDefault();
        e.stopPropagation();
        inputContainer.classList.remove('border-2', 'border-blue-500', 'border-dashed');
      });

      inputContainer.addEventListener('drop', function (e) {
        e.preventDefault();
        e.stopPropagation();
        inputContainer.classList.remove('border-2', 'border-blue-500', 'border-dashed');

        const files = Array.from(e.dataTransfer.files);
        if (files.length > 0) {
          uploadFiles(files);
        }
      });

      // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
      function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
      }

      // è·å–æ–‡ä»¶ç±»å‹å›¾æ ‡
      function getFileIcon(mimetype, filename) {
        if (mimetype.startsWith('image/')) {
          return 'ri-image-line';
        } else if (mimetype.startsWith('audio/')) {
          return 'ri-music-line';
        } else if (mimetype.startsWith('video/')) {
          return 'ri-video-line';
        } else if (mimetype === 'application/pdf') {
          return 'ri-file-pdf-line';
        } else if (mimetype.includes('word') || filename.endsWith('.doc') || filename.endsWith('.docx')) {
          return 'ri-file-word-line';
        } else if (mimetype.includes('excel') || filename.endsWith('.xls') || filename.endsWith('.xlsx')) {
          return 'ri-file-excel-line';
        } else if (mimetype.startsWith('text/')) {
          return 'ri-file-text-line';
        } else {
          return 'ri-file-line';
        }
      }

      // ä¸Šä¼ æ–‡ä»¶
      async function uploadFiles(files) {
        if (files.length === 0) return;

        // é™åˆ¶æ–‡ä»¶æ•°é‡
        if (currentUploadedFiles.length + files.length > 5) {
          showToast('æœ€å¤šåªèƒ½ä¸Šä¼ 5ä¸ªæ–‡ä»¶', 'error');
          return;
        }

        try {
          // ä¸ºæ¯ä¸ªæ–‡ä»¶åˆ›å»ºä¸Šä¼ å¡ç‰‡
          const uploadPromises = files.map(file => uploadSingleFile(file));
          const results = await Promise.all(uploadPromises);

          // æ·»åŠ æˆåŠŸä¸Šä¼ çš„æ–‡ä»¶åˆ°å½“å‰åˆ—è¡¨
          results.forEach(result => {
            if (result) {
              currentUploadedFiles.push(result);
            }
          });

          updateFilesDisplay();

        } catch (error) {
          console.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error);
          showToast('æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
        }
      }

      // ä¸Šä¼ å•ä¸ªæ–‡ä»¶
      async function uploadSingleFile(file) {
        // åˆ›å»ºä¸Šä¼ ä¸­çš„å¡ç‰‡
        const fileCard = createFileCard(file, 'uploading');
        uploadedFilesDisplay.appendChild(fileCard);
        uploadedFilesDisplay.classList.remove('hidden');

        try {
          const formData = new FormData();
          formData.append('file', file);

          const response = await fetch('/api/upload/single', {
            method: 'POST',
            body: formData
          });

          const result = await response.json();

          if (result.success) {
            // æ›´æ–°å¡ç‰‡çŠ¶æ€ä¸ºæˆåŠŸ
            updateFileCard(fileCard, result.data, 'success');
            return result.data;
          } else {
            throw new Error(result.error || 'ä¸Šä¼ å¤±è´¥');
          }
        } catch (error) {
          // æ›´æ–°å¡ç‰‡çŠ¶æ€ä¸ºå¤±è´¥
          updateFileCard(fileCard, { originalname: file.name, size: file.size }, 'error', error.message);
          return null;
        }
      }

      // åˆ›å»ºæ–‡ä»¶å¡ç‰‡
      function createFileCard(file, status = 'success', errorMessage = '') {
        const fileCard = document.createElement('div');
        fileCard.className = 'flex items-start space-x-3 p-3 bg-gray-50 rounded-lg border';

        const isImage = file.type ? file.type.startsWith('image/') : file.originalname?.match(/\.(jpg|jpeg|png|gif|webp|bmp|tiff|svg)$/i);
        const isAudio = file.type ? file.type.startsWith('audio/') : file.originalname?.match(/\.(mp3|wav|ogg|aac|flac|m4a|wma)$/i);
        const isVideo = file.type ? file.type.startsWith('video/') : file.originalname?.match(/\.(mp4|avi|mov|wmv|webm|3gp|flv|mkv)$/i);
        const icon = file.type ? getFileIcon(file.type, file.originalname || file.name) : getFileIcon('', file.originalname || file.name);

        let statusHtml = '';
        let statusColor = '';

        if (status === 'uploading') {
          statusHtml = '<div class="text-xs text-blue-600">ä¸Šä¼ ä¸­...</div>';
          statusColor = 'text-blue-600';
        } else if (status === 'success') {
          if (isImage) {
            statusHtml = '<div class="text-xs text-orange-600">ä»…è¯†åˆ«é™„ä»¶ä¸­çš„æ–‡å­—</div>';
            statusColor = 'text-orange-600';
          } else if (isAudio) {
            statusHtml = '<div class="text-xs text-purple-600">éŸ³é¢‘æ–‡ä»¶å·²ä¸Šä¼ </div>';
            statusColor = 'text-purple-600';
          } else if (isVideo) {
            statusHtml = '<div class="text-xs text-indigo-600">è§†é¢‘æ–‡ä»¶å·²ä¸Šä¼ </div>';
            statusColor = 'text-indigo-600';
          } else {
            statusHtml = '<div class="text-xs text-green-600">ä¸Šä¼ æˆåŠŸ</div>';
            statusColor = 'text-green-600';
          }
        } else if (status === 'error') {
          statusHtml = `<div class="text-xs text-red-600">ä¸Šä¼ å¤±è´¥: ${errorMessage}</div>`;
          statusColor = 'text-red-600';
        }

        fileCard.innerHTML = `
      <div class="flex-shrink-0">
        <i class="${icon} text-xl text-gray-600"></i>
      </div>
      <div class="flex-1 min-w-0">
        <div class="text-sm font-medium text-gray-900 truncate">${file.originalname || file.name}</div>
        <div class="text-xs text-gray-500">${formatFileSize(file.size)}</div>
        ${statusHtml}
      </div>
      <button onclick="removeFileCard(this)" class="flex-shrink-0 w-6 h-6 flex items-center justify-center text-white bg-red-500 rounded-full hover:bg-red-600 transition-colors">
        <i class="ri-close-line text-xs"></i>
      </button>
    `;

        return fileCard;
      }

      // æ›´æ–°æ–‡ä»¶å¡ç‰‡
      function updateFileCard(fileCard, fileData, status, errorMessage = '') {
        const statusElement = fileCard.querySelector('.text-xs:last-of-type');
        const isImage = fileData.mimetype ? fileData.mimetype.startsWith('image/') : fileData.originalname?.match(/\.(jpg|jpeg|png|gif|webp|bmp|tiff|svg)$/i);
        const isAudio = fileData.mimetype ? fileData.mimetype.startsWith('audio/') : fileData.originalname?.match(/\.(mp3|wav|ogg|aac|flac|m4a|wma)$/i);
        const isVideo = fileData.mimetype ? fileData.mimetype.startsWith('video/') : fileData.originalname?.match(/\.(mp4|avi|mov|wmv|webm|3gp|flv|mkv)$/i);

        if (status === 'success') {
          if (isImage) {
            statusElement.className = 'text-xs text-orange-600';
            statusElement.textContent = 'ä»…è¯†åˆ«é™„ä»¶ä¸­çš„æ–‡å­—';

            // æ¨¡æ‹Ÿæ–‡å­—è¯†åˆ«è¿‡ç¨‹
            setTimeout(() => {
              statusElement.textContent = 'æœªæå–åˆ°æ–‡å­—';
              statusElement.className = 'text-xs text-gray-500';
            }, 2000);
          } else if (isAudio) {
            statusElement.className = 'text-xs text-purple-600';
            statusElement.textContent = 'éŸ³é¢‘æ–‡ä»¶å·²ä¸Šä¼ ';
          } else if (isVideo) {
            statusElement.className = 'text-xs text-indigo-600';
            statusElement.textContent = 'è§†é¢‘æ–‡ä»¶å·²ä¸Šä¼ ';
          } else {
            statusElement.className = 'text-xs text-green-600';
            statusElement.textContent = 'ä¸Šä¼ æˆåŠŸ';
          }
        } else if (status === 'error') {
          statusElement.className = 'text-xs text-red-600';
          statusElement.textContent = `ä¸Šä¼ å¤±è´¥: ${errorMessage}`;
        }

        // å­˜å‚¨æ–‡ä»¶æ•°æ®åˆ°å¡ç‰‡å…ƒç´ 
        fileCard.fileData = fileData;
      }

      // åˆ é™¤æ–‡ä»¶å¡ç‰‡
      window.removeFileCard = function (button) {
        const fileCard = button.closest('.flex.items-start');
        const fileData = fileCard.fileData;

        // ä»å½“å‰ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨ä¸­ç§»é™¤
        if (fileData && fileData.filename) {
          currentUploadedFiles = currentUploadedFiles.filter(f => f.filename !== fileData.filename);

          // åˆ é™¤æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶
          fetch(`/api/upload/file/${fileData.filename}`, { method: 'DELETE' })
            .catch(error => console.error('åˆ é™¤æœåŠ¡å™¨æ–‡ä»¶å¤±è´¥:', error));
        }

        // ç§»é™¤å¡ç‰‡
        fileCard.remove();

        // å¦‚æœæ²¡æœ‰æ–‡ä»¶äº†ï¼Œéšè—å®¹å™¨
        if (uploadedFilesDisplay.children.length === 0) {
          uploadedFilesDisplay.classList.add('hidden');
        }
      };

      // æ›´æ–°æ–‡ä»¶æ˜¾ç¤º
      function updateFilesDisplay() {
        if (currentUploadedFiles.length === 0) {
          uploadedFilesDisplay.classList.add('hidden');
        } else {
          uploadedFilesDisplay.classList.remove('hidden');
        }
      }

      // æ¸…ç©ºå½“å‰ä¸Šä¼ çš„æ–‡ä»¶ï¼ˆåœ¨å‘é€æ¶ˆæ¯åè°ƒç”¨ï¼‰
      window.clearUploadedFiles = function () {
        currentUploadedFiles = [];
        uploadedFilesDisplay.innerHTML = '';
        uploadedFilesDisplay.classList.add('hidden');
      };

      // è·å–å½“å‰ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨ï¼ˆå‘é€æ¶ˆæ¯æ—¶ä½¿ç”¨ï¼‰
      window.getCurrentUploadedFiles = function () {
        return currentUploadedFiles;
      };

      // ç§»åŠ¨ç«¯èœå•åŠŸèƒ½ - å°†å‡½æ•°å®šä¹‰ä¸ºå…¨å±€å‡½æ•°
      const sidebar = document.getElementById('sidebar');
      const mobileOverlay = document.getElementById('mobile-overlay');
      const mobileMenuBtn = document.getElementById('mobile-menu-btn');
      const closeSidebarBtn = document.getElementById('close-sidebar-btn');

      // æ˜¾ç¤ºä¾§è¾¹æ  - å…¨å±€å‡½æ•°
      window.showSidebar = function () {
        if (window.innerWidth <= 768) {
          sidebar.classList.add('show');
          mobileOverlay.classList.add('show');
          document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
        }
      }

      // éšè—ä¾§è¾¹æ  - å…¨å±€å‡½æ•°
      window.hideSidebar = function () {
        sidebar.classList.remove('show');
        mobileOverlay.classList.remove('show');
        document.body.style.overflow = ''; // æ¢å¤èƒŒæ™¯æ»šåŠ¨
      }

      // ç§»åŠ¨ç«¯èœå•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener('click', window.showSidebar);
      }

      // å…³é—­ä¾§è¾¹æ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      if (closeSidebarBtn) {
        closeSidebarBtn.addEventListener('click', window.hideSidebar);
      }

      // é®ç½©å±‚ç‚¹å‡»äº‹ä»¶ï¼ˆç‚¹å‡»é®ç½©å…³é—­ä¾§è¾¹æ ï¼‰
      if (mobileOverlay) {
        mobileOverlay.addEventListener('click', window.hideSidebar);
      }

      // çª—å£å¤§å°æ”¹å˜æ—¶çš„å¤„ç†
      window.addEventListener('resize', () => {
        if (window.innerWidth > 768) {
          // å¦‚æœå±å¹•å˜å¤§ï¼Œéšè—ç§»åŠ¨ç«¯ä¾§è¾¹æ 
          window.hideSidebar();
        }
      });

      // é˜»æ­¢ä¾§è¾¹æ å†…éƒ¨ç‚¹å‡»äº‹ä»¶å†’æ³¡åˆ°é®ç½©å±‚
      if (sidebar) {
        sidebar.addEventListener('click', (e) => {
          e.stopPropagation();
        });
      }

      // ESCé”®å…³é—­ä¾§è¾¹æ 
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && window.innerWidth <= 768) {
          window.hideSidebar();
        }
      });
    });
  </script>

  <!-- æ–‡ä»¶è¾“å…¥ -->
  <input type="file" id="file-input" multiple accept="image/*,audio/*,video/*,.pdf,.doc,.docx,.txt,.xls,.xlsx"
    style="display: none;">
</body>

</html>