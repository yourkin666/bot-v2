# AI 小子用户系统功能说明

## 🎉 功能完成情况

✅ **已完成邮箱注册登录系统**

- 基于邮箱的用户注册和登录
- 邮箱验证码验证机制
- JWT Token 认证
- 按用户邮箱隔离聊天数据
- 自动数据迁移功能

## 🔧 核心功能

### 1. 用户认证系统

- **邮箱注册**：6 位数字验证码，密码加密存储
- **邮箱登录**：支持记住登录状态
- **自动登出**：Token 过期自动跳转登录页
- **会话管理**：服务器端会话持久化

### 2. 数据隔离系统

- **独立存储**：每个用户拥有独立的聊天记录文件
- **数据迁移**：自动将旧数据迁移到默认用户
- **权限控制**：用户只能访问自己的聊天记录
- **安全防护**：防止路径遍历和数据泄露

### 3. 前端界面

- **登录注册页面**：现代化玻璃态设计
- **用户状态显示**：侧边栏显示当前用户信息
- **一键登出**：方便的退出登录功能
- **响应式设计**：适配不同设备屏幕

## 📁 新增文件

```
bot-v2/
├── login.html                 # 登录注册页面
├── services/
│   ├── userService.js        # 用户管理服务
│   └── emailService.js       # 邮件发送服务
├── middleware/
│   └── auth.js               # 认证中间件
├── routes/
│   └── auth.js               # 认证相关路由
├── 邮件配置说明.md            # 邮件配置指南
└── 用户系统功能说明.md        # 本文档
```

## 🔄 修改文件

### 核心文件修改

- `config.js` - 添加邮件和认证配置
- `package.json` - 添加新依赖包
- `server.js` - 集成认证系统和会话管理
- `utils/storage.js` - 支持按用户隔离数据
- `routes/chat.js` - 添加认证验证
- `index.html` - 添加登录检查和用户界面

## 🛡️ 安全机制

### 认证安全

- **密码加密**：使用 bcrypt 进行密码哈希
- **JWT Token**：防篡改的用户身份令牌
- **验证码机制**：防止恶意注册和暴力破解
- **Token 过期**：自动处理过期令牌

### 数据安全

- **文件隔离**：每个用户独立的数据目录
- **权限验证**：API 级别的用户权限检查
- **数据清理**：定时清理过期验证码
- **输入验证**：防止 SQL 注入和 XSS 攻击

## 🚀 使用流程

### 首次使用

1. **配置邮件服务**：修改`config.js`中的 SMTP 配置
2. **启动服务**：`npm start`
3. **访问系统**：打开 http://localhost:3002
4. **注册账户**：输入邮箱和密码，接收验证码
5. **开始使用**：登录后即可使用 AI 聊天功能

### 日常使用

1. **自动登录**：Token 有效期内无需重复登录
2. **独立聊天**：每个用户的聊天记录完全隔离
3. **随时登出**：点击侧边栏登出按钮
4. **重新登录**：Token 过期会自动跳转登录页

## 📊 数据结构

### 用户数据

```json
{
  "email@example.com": {
    "id": "uuid",
    "email": "email@example.com",
    "password": "hashed_password",
    "isVerified": true,
    "createdAt": "2025-01-30T...",
    "updatedAt": "2025-01-30T...",
    "lastLoginAt": "2025-01-30T..."
  }
}
```

### 聊天数据

```
data/users/
├── email_example_com_hash1234/
│   └── chats.json           # 该用户的所有聊天记录
├── another_email_com_hash567/
│   └── chats.json           # 另一用户的聊天记录
└── legacy_default_com_hash890/
    └── chats.json           # 迁移的旧数据
```

## 🔧 API 接口

### 认证相关

- `POST /api/auth/send-verification-code` - 发送验证码
- `POST /api/auth/register` - 用户注册
- `POST /api/auth/login` - 用户登录
- `POST /api/auth/logout` - 用户登出
- `GET /api/auth/me` - 获取当前用户信息

### 聊天相关（需认证）

- `POST /api/chat/send` - 发送消息
- `GET /api/chat/history` - 获取聊天历史
- `GET /api/chat/:chatId` - 获取特定聊天
- `DELETE /api/chat/:chatId` - 删除聊天

## ⚙️ 配置项

### 邮件配置

```javascript
email: {
  smtp: {
    host: 'smtp.qq.com',
    port: 587,
    auth: {
      user: '你的邮箱@qq.com',
      pass: '你的授权码'
    }
  }
}
```

### 认证配置

```javascript
auth: {
  jwtSecret: 'your-secret-key',
  jwtExpiresIn: '7d',
  verificationCodeExpiry: 10 * 60 * 1000
}
```

## 🛠️ 维护功能

### 自动清理

- **过期验证码**：每小时清理一次
- **无效会话**：自动清理过期的用户会话

### 监控统计

- **用户统计**：`GET /api/auth/stats` 获取用户数量
- **聊天统计**：`GET /api/chat/stats/user` 获取用户聊天统计

## 📋 注意事项

### 首次部署

1. 必须配置 SMTP 邮件服务才能使用注册功能
2. 生产环境请修改 JWT 和会话密钥
3. 确保数据目录有写入权限

### 数据迁移

- 系统会自动将现有聊天数据迁移到 `legacy@default.com` 用户
- 原数据会备份为 `chats_backup.json`
- 迁移过程无需人工干预

### 性能优化

- 用户数据和聊天数据分别存储，提高访问效率
- 验证码定时清理，避免内存泄露
- JWT Token 减少数据库查询次数

## 🎯 后续优化建议

1. **数据库支持**：可考虑使用 MySQL 或 MongoDB 替换 JSON 文件
2. **密码重置**：添加忘记密码功能
3. **用户头像**：支持自定义用户头像
4. **多设备同步**：支持多设备登录同步
5. **管理后台**：添加用户管理和统计后台

---

**恭喜！邮箱注册登录系统已完全实现，每个用户现在都拥有独立的聊天记录。**
